# ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã

**–î–∞—Ç–∞:** 2024-12-02  
**–°—Ç–∞—Ç—É—Å:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 1. Message Queue –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ `fetch()` –º–æ–≥–ª–∞ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ bot.

**–†–µ—à–µ–Ω–∏–µ:**

- ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω Yandex Message Queue (YMQ)
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `backend/src/services/queue.ts` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ—á–µ—Ä–µ–¥—å
- ‚úÖ –°–æ–∑–¥–∞–Ω consumer –≤ `bot/src/queueConsumer.ts` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ –ø—Ä—è–º–æ–π webhook –¥–ª—è development
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–§–∞–π–ª—ã:**

- `backend/src/services/queue.ts`
- `bot/src/queueConsumer.ts`
- `docs/MESSAGE_QUEUE_SETUP.md`

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

```bash
YMQ_ENDPOINT=https://message-queue.api.cloud.yandex.net
YMQ_QUEUE_URL=https://message-queue.api.cloud.yandex.net/...
YMQ_ACCESS_KEY_ID=...
YMQ_SECRET_ACCESS_KEY=...
```

---

### ‚úÖ 2. Admin Auth (JWT + Refresh Tokens)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ—Å—Ç–æ–π —Ç–æ–∫–µ–Ω –∏–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–±–µ–∑–æ–ø–∞—Å–µ–Ω –∏ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Å—Å–∏—è–º–∏.

**–†–µ—à–µ–Ω–∏–µ:**

- ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω JWT –¥–ª—è access tokens (15 –º–∏–Ω—É—Ç)
- ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω refresh token –º–µ—Ö–∞–Ω–∏–∑–º (7 –¥–Ω–µ–π)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `admin_sessions` –≤ –ë–î
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã endpoints: `/login`, `/refresh`, `/logout`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT

**–§–∞–π–ª—ã:**

- `backend/src/services/jwt.ts`
- `backend/src/repositories/adminRepository.ts`
- `backend/src/routes/admin-auth.ts`
- `backend/src/middleware/adminAuth.ts`
- `backend/src/db/migrations/002_create_admin_tables.ts`
- `scripts/create-admin.ts`
- `docs/ADMIN_AUTH_SETUP.md`

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞
npm run create:admin <email> <password>

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npm run migrate
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

```bash
JWT_SECRET=your-super-secret-jwt-key
JWT_REFRESH_SECRET=your-super-secret-refresh-key
```

---

### ‚úÖ 3. –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (Jest)

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–æ–≤ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è production.

**–†–µ—à–µ–Ω–∏–µ:**

- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Jest —Å TypeScript
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã unit —Ç–µ—Å—Ç—ã –¥–ª—è Telegram Auth (6 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã unit —Ç–µ—Å—Ç—ã –¥–ª—è JWT (8 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã integration —Ç–µ—Å—Ç—ã –¥–ª—è Admin Auth (13 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –í—Å–µ–≥–æ: 27 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç ‚úÖ

**–§–∞–π–ª—ã:**

- `backend/jest.config.js`
- `backend/src/__tests__/setup.ts`
- `backend/src/utils/__tests__/telegramAuth.test.ts`
- `backend/src/services/__tests__/jwt.test.ts`
- `backend/src/routes/__tests__/admin-auth.test.ts`
- `backend/src/__tests__/README.md`

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
npm test              # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
npm run test:watch    # Watch —Ä–µ–∂–∏–º
npm run test:coverage  # –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
```

---

### ‚úÖ 4. –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤ YDB

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∑–∞–º–µ–¥–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:**

- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `003_add_composite_indexes`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã:
  - `idx_matches_user1_user2` - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –º–∞—Ç—á–∞
  - `idx_matches_user1_created` - –¥–ª—è –º–∞—Ç—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
  - `idx_matches_user2_created` - –¥–ª—è –º–∞—Ç—á–µ–π, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ç–æ—Ä–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
  - `idx_likes_from_to_event` - –¥–ª—è –≤–∑–∞–∏–º–Ω—ã—Ö –ª–∞–π–∫–æ–≤ –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö
  - `idx_likes_to_created` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –ª–∞–π–∫–æ–≤ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤

**–§–∞–π–ª—ã:**

- `backend/src/db/migrations/003_add_composite_indexes.ts`
- `backend/src/db/schema.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
- `backend/src/repositories/matchRepository.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
- `docs/DATABASE_INDEXES.md`

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
npm run migrate  # –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã
```

---

### ‚úÖ 5. Cache Invalidation –≤ React Query

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ invalidation –ø–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É.

**–†–µ—à–µ–Ω–∏–µ:**

- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ query keys –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ invalidateQueries –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Ö—É–∫–∏: `useFeed`, `useMatches`, `useSavedEvents`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã optimistic updates –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ UI
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è invalidation –ø–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π

**–§–∞–π–ª—ã:**

- `frontend/src/lib/queryClient.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
- `frontend/src/hooks/useFeed.ts`
- `frontend/src/hooks/useMatches.ts`
- `frontend/src/hooks/useSavedEvents.ts`
- `frontend/src/hooks/index.ts`
- `frontend/src/hooks/README.md`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
import { useFeed, useLikeAction } from '@/hooks';

const { data } = useFeed({ type: 'events' });
const likeMutation = useLikeAction();

// –ü–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è
likeMutation.mutate({ action: 'like', targetId: 'user-123' });
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ó–∞–¥–∞—á–∞             | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ | –§–∞–π–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ |
| ------------------ | ------ | -------------- | ---------------- |
| Message Queue      | ‚úÖ     | 3              | 2                |
| Admin Auth         | ‚úÖ     | 5              | 2                |
| –¢–µ—Å—Ç—ã              | ‚úÖ     | 4              | 1                |
| –ò–Ω–¥–µ–∫—Å—ã            | ‚úÖ     | 2              | 3                |
| Cache Invalidation | ‚úÖ     | 4              | 1                |
| **–ò—Ç–æ–≥–æ**          | **‚úÖ** | **18**         | **9**            |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:

1. **–û–±–Ω–æ–≤–∏—Ç—å HomePage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ö—É–∫–æ–≤**
   - –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã API –Ω–∞ `useFeed` –∏ `useLikeAction`
   - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

2. **–û–±–Ω–æ–≤–∏—Ç—å MatchesPage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ö—É–∫–æ–≤**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `useMatches` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ API

3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å YMQ –≤ production**
   - –°–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –≤ Yandex Cloud
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å credentials
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É

4. **–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞**

   ```bash
   npm run create:admin admin@example.com securePassword123
   ```

5. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏**
   ```bash
   npm run migrate
   ```

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤ (e2e, integration)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CDN –¥–ª—è Object Storage
- –î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å GDPR compliance

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã:

- `docs/MESSAGE_QUEUE_SETUP.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Message Queue
- `docs/ADMIN_AUTH_SETUP.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Admin Auth
- `docs/DATABASE_INDEXES.md` - –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- `backend/src/__tests__/README.md` - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∞–º
- `frontend/src/hooks/README.md` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—É–∫–æ–≤

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤ production —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] YMQ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] JWT_SECRET –∏ JWT_REFRESH_SECRET —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (—Å–∏–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã!)
- [ ] –°–æ–∑–¥–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–¥–º–∏–Ω —á–µ—Ä–µ–∑ `npm run create:admin`
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω—ã: `npm run migrate`
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç: `npm test`
- [ ] Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–µ —Ö—É–∫–∏ –¥–ª—è React Query

---

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã! üéâ**

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é.
