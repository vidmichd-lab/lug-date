# Анализ ошибки 403 в бекенде

## Возможные причины ошибки 403

### 1. ❌ Проблема с CORS

**Файл**: `backend/src/index.ts:118-183`

**Проблема**: Если origin запроса не в списке разрешенных, CORS middleware может вернуть ошибку, которая выглядит как 403.

**Проверка**:

- Убедитесь, что `ADMIN_ORIGINS` и `ALLOWED_ORIGINS` правильно настроены в GitHub Secrets
- Проверьте логи бекенда на наличие `cors_blocked`

**Решение**: Добавить более детальное логирование CORS в production режиме.

---

### 2. ❌ Проблема с Admin Auth

**Файл**: `backend/src/middleware/adminAuth.ts:44, 72`

**Проблема**: Admin auth middleware возвращает 403, если:

- Нет Authorization header
- Токен не совпадает с `ADMIN_TOKEN`

**Проверка**:

- Убедитесь, что токен передается в заголовке: `Authorization: Bearer <token>`
- Проверьте, что `ADMIN_TOKEN` в GitHub Secrets совпадает с токеном, который используется в админке

**Решение**: Добавить более детальное логирование для диагностики.

---

### 3. ❌ Проблема с Rate Limiting

**Файл**: `backend/src/middleware/rateLimiter.ts`

**Проблема**: Rate limiter обычно возвращает 429, но может быть настроен на 403.

**Проверка**: Проверьте логи на наличие `RATE_LIMIT_EXCEEDED`.

---

### 4. ❌ Проблема с OPTIONS запросами (CORS Preflight)

**Проблема**: Если OPTIONS запросы не обрабатываются правильно, браузер может получить 403.

**Проверка**: Убедитесь, что CORS middleware правильно обрабатывает OPTIONS запросы.

---

## Диагностика

### 1. Проверить логи бекенда

В Yandex Cloud Console проверьте логи контейнера на наличие:

- `cors_blocked` - CORS заблокировал запрос
- `admin_auth_failed` - Admin auth не прошел
- `rate_limit_exceeded` - Превышен лимит запросов

### 2. Проверить переменные окружения

Убедитесь, что в контейнере установлены:

- `ADMIN_ORIGINS` - список разрешенных origin'ов для админки
- `ALLOWED_ORIGINS` - список разрешенных origin'ов
- `ADMIN_TOKEN` - токен для админки

### 3. Проверить запросы в браузере

Откройте DevTools → Network и проверьте:

- **Request Headers**: Есть ли `Authorization: Bearer <token>`?
- **Response Headers**: Есть ли CORS заголовки?
- **Status Code**: Точный код ошибки (может быть не 403, а другой)

---

## Быстрое исправление

### 1. Добавить детальное логирование CORS

Добавить логирование CORS в production для диагностики.

### 2. Проверить ADMIN_ORIGINS в workflow

Убедиться, что `ADMIN_ORIGINS` правильно передается в контейнер.

### 3. Добавить fallback для CORS

Если origin не найден, логировать, но не блокировать (для отладки).
