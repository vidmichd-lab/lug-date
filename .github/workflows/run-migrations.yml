name: Run Database Migrations

on:
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "Run workflow"
  push:
    branches: [main]
    paths:
      - 'backend/src/db/migrations/**'
      - 'backend/src/db/connection.ts'
      - 'backend/src/config.ts'
      - '.github/workflows/run-migrations.yml'

env:
  NODE_VERSION: '20'

jobs:
  run-migrations:
    name: Run database migrations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Run migrations
        timeout-minutes: 10
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YDB_ENDPOINT: ${{ secrets.YDB_ENDPOINT }}
          YDB_DATABASE: ${{ secrets.YDB_DATABASE }}
        run: |
          cd backend

          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å Service Account –∫–ª—é—á–æ–º
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          chmod 600 /tmp/yc-sa-key.json

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º YC_SERVICE_ACCOUNT_KEY (JSON —Å—Ç—Ä–æ–∫–∞) –Ω–∞–ø—Ä—è–º—É—é
          # –≠—Ç–æ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ —Ñ–∞–π–ª–æ–º –∏ metadata service –≤ getCredentialsFromEnv
          export YC_SERVICE_ACCOUNT_KEY="$YC_SERVICE_ACCOUNT_KEY"

          # –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –∫–∞–∫ fallback
          export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/yc-sa-key.json"

          echo "‚úÖ Using YC_SERVICE_ACCOUNT_KEY (JSON string) - has priority over metadata service"

          # –Ø–≤–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º metadata service (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ GitHub Actions)
          # YDB SDK –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ metadata service
          export YDB_METADATA_CREDENTIALS="0"
          export METADATA_URL=""
          export GCE_METADATA_HOST=""
          unset METADATA_URL
          unset GCE_METADATA_HOST

          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è metadata service
          export NO_PROXY="*"
          export NO_METADATA="1"

          # Skip driver.ready() check in CI - it can hang in GitHub Actions
          # The driver will establish connection on first query instead
          export YDB_SKIP_READY_CHECK="true"
          echo "‚úÖ Skipping driver.ready() check (YDB_SKIP_READY_CHECK=true) - connection will be established on first query"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          if [ -z "$YDB_ENDPOINT" ] || [ -z "$YDB_DATABASE" ]; then
            echo "‚ùå ERROR: YDB_ENDPOINT or YDB_DATABASE is not set"
            exit 1
          fi

          echo "üîå Connecting to YDB..."
          echo "Endpoint: $YDB_ENDPOINT"
          echo "Database: $YDB_DATABASE"
          echo "Service Account Key File: $YC_SERVICE_ACCOUNT_KEY_FILE"
          echo ""
          echo "üìã Database path format check:"
          if [[ "$YDB_DATABASE" =~ ^/ru-central1/ ]]; then
            echo "  ‚úÖ Database path format is correct (starts with /ru-central1/)"
            # Extract Cloud ID (first part) and database ID (second part) for verification
            if [[ "$YDB_DATABASE" =~ ^/ru-central1/([^/]+)/(.+)$ ]]; then
              CLOUD_ID_IN_PATH="${BASH_REMATCH[1]}"
              DB_ID="${BASH_REMATCH[2]}"
              echo "  ‚òÅÔ∏è  Cloud ID in path: $CLOUD_ID_IN_PATH"
              echo "  üóÑÔ∏è  Database ID: $DB_ID"
              echo ""
              echo "  ‚ö†Ô∏è  IMPORTANT: Path uses Cloud ID, NOT Folder ID!"
              echo "     If you see 'Database not found' error, verify:"
              echo "     1. Cloud ID in path ($CLOUD_ID_IN_PATH) is correct"
              echo "     2. Database ID ($DB_ID) matches the database in Yandex Cloud Console"
              echo "     3. Check database path in Console: https://console.cloud.yandex.ru/cloud?section=resources"
              echo "        The path shown in Console should match: /ru-central1/$CLOUD_ID_IN_PATH/$DB_ID"
            fi
          else
            echo "  ‚ö†Ô∏è  WARNING: Database path should start with /ru-central1/"
            echo "  Current path: $YDB_DATABASE"
          fi
          echo ""
          echo "üí° If you see 'Database not found' error:"
          echo "  1. Verify the database path in Yandex Cloud Console:"
          echo "     - Open: https://console.cloud.yandex.ru/cloud?section=resources"
          echo "     - Find your YDB database"
          echo "     - Check the 'Database path' field - it should match: $YDB_DATABASE"
          echo "  2. CRITICAL: Path uses Cloud ID (not Folder ID)!"
          echo "     - Cloud ID format: /ru-central1/<cloud-id>/<database-id>"
          echo "     - If your path uses Folder ID, it will fail!"
          echo "     - To find Cloud ID: https://console.cloud.yandex.ru/cloud?section=overview"
          echo "  3. Ensure Service Account has 'YDB Editor' role on the database"
          echo "  4. Check Service Account key is valid and not expired"
          echo "  5. Verify YDB_ENDPOINT is: grpcs://ydb.serverless.yandexcloud.net:2135"
          echo "     (without ?database= parameter)"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
          if [ ! -f "$YC_SERVICE_ACCOUNT_KEY_FILE" ]; then
            echo "‚ùå ERROR: Service Account key file not found"
            exit 1
          fi

          echo "‚úÖ Service Account key file exists"

          # –ò–∑–≤–ª–µ–∫–∞–µ–º Service Account ID –∏–∑ –∫–ª—é—á–∞
          if command -v jq &> /dev/null; then
            SERVICE_ACCOUNT_ID=$(jq -r '.service_account_id' "$YC_SERVICE_ACCOUNT_KEY_FILE" 2>/dev/null || echo "unknown")
            echo "   Service Account ID: $SERVICE_ACCOUNT_ID"
          fi

          # –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          echo ""
          echo "üìä Connection Details:"
          echo "  Endpoint: $YDB_ENDPOINT"
          echo "  Database Path: $YDB_DATABASE"
          if [[ "$YDB_ENDPOINT" == *"?database="* ]]; then
            echo "  ‚ö†Ô∏è  WARNING: Endpoint already contains ?database= parameter"
            echo "  Full endpoint: $YDB_ENDPOINT"
            echo "  This might cause issues if YDB_DATABASE is also set"
          else
            # –§–æ—Ä–º–∏—Ä—É–µ–º connectionString –∫–∞–∫ –≤ –∫–æ–¥–µ
            if [[ "$YDB_ENDPOINT" == */ ]]; then
              SEPARATOR="?"
            else
              SEPARATOR="/?"
            fi
            EXPECTED_CS="${YDB_ENDPOINT}${SEPARATOR}database=$(echo "$YDB_DATABASE" | jq -sRr @uri 2>/dev/null || echo "$YDB_DATABASE")"
            echo "  Expected connectionString: ${EXPECTED_CS}"
          fi
          echo ""
          echo "üí° If you see 'Database not found' error:"
          echo "   1. Verify database path in Console matches exactly: $YDB_DATABASE"
          echo "      - Open: https://console.cloud.yandex.ru/cloud?section=resources"
          echo "      - Find your YDB database and check 'Database path' field"
          echo "   2. CRITICAL: Ensure path uses Cloud ID, NOT Folder ID!"
          echo "      - Correct: /ru-central1/<cloud-id>/<database-id>"
          echo "      - Wrong: /ru-central1/<folder-id>/<database-id>"
          echo "      - Find Cloud ID: https://console.cloud.yandex.ru/cloud?section=overview"
          echo "   3. Ensure Service Account '$SERVICE_ACCOUNT_ID' has 'YDB Editor' role"
          echo "   4. Wait 1-2 minutes after assigning roles (they apply with delay)"
          echo "   5. Verify YDB_ENDPOINT is: grpcs://ydb.serverless.yandexcloud.net:2135"
          echo "      (without ?database= parameter)"
          echo ""

          echo ""
          echo "üöÄ Running migrations..."
          npm run migrate

      - name: Check migration status
        timeout-minutes: 3
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YDB_ENDPOINT: ${{ secrets.YDB_ENDPOINT }}
          YDB_DATABASE: ${{ secrets.YDB_DATABASE }}
        run: |
          cd backend

          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å Service Account –∫–ª—é—á–æ–º
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          chmod 600 /tmp/yc-sa-key.json
          export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/yc-sa-key.json"
          # –û—Å—Ç–∞–≤–ª—è–µ–º YC_SERVICE_ACCOUNT_KEY –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ JSON —Å—Ç—Ä–æ–∫–∏ –Ω–∞–¥ —Ñ–∞–π–ª–æ–º
          export YC_SERVICE_ACCOUNT_KEY="$YC_SERVICE_ACCOUNT_KEY"

          # –Ø–≤–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º metadata service (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ GitHub Actions)
          export YDB_METADATA_CREDENTIALS="0"
          export METADATA_URL=""
          export GCE_METADATA_HOST=""
          export NO_METADATA="1"
          unset METADATA_URL
          unset GCE_METADATA_HOST

          # Skip driver.ready() check in CI - it can hang in GitHub Actions
          export YDB_SKIP_READY_CHECK="true"

          echo "üìã Checking migration status..."
          npm run migrate:status
