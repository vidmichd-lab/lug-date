name: Run Database Migrations

on:
  workflow_dispatch: # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "Run workflow"

env:
  NODE_VERSION: '20'

jobs:
  run-migrations:
    name: Run database migrations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Run PostgreSQL migrations
        timeout-minutes: 10
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå ERROR: DATABASE_URL is not set"
            echo "Please set DATABASE_URL in GitHub Secrets"
            exit 1
          fi

          echo "üîå Connecting to PostgreSQL..."
          echo "Database URL: ${DATABASE_URL:0:30}... (hidden for security)"
          echo ""
          echo "üöÄ Running PostgreSQL migrations..."
          NODE_ENV=production npm run migrate:postgres

      - name: Check migration status
        timeout-minutes: 3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üìã Checking migration status..."
          NODE_ENV=production npm run migrate:status:postgres
