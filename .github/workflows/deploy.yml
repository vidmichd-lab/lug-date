name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Build all packages
        run: npm run build --workspace=frontend --workspace=backend --workspace=bot --workspace=admin

  deploy:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production
      url: https://api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          if [ -n "$YC_CLOUD_ID" ]; then
            yc config set cloud-id "$YC_CLOUD_ID" || true
          fi
          if [ -n "$YC_FOLDER_ID" ]; then
            yc config set folder-id "$YC_FOLDER_ID" || true
          fi

      - name: Get Backend URL
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID: ${{ secrets.YC_CONTAINER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          echo "üîç Getting backend URL..."
          echo "YC_CONTAINER_ID: ${YC_CONTAINER_ID:0:20}..."
          echo "YC_FOLDER_ID: ${YC_FOLDER_ID}"

          # Try to get BACKEND_URL
          BACKEND_URL=""
          CONTAINER_JSON=""

          if [ -n "${YC_CONTAINER_ID}" ]; then
            echo "üîç Fetching container info using container ID..."
            CONTAINER_JSON=$(yc serverless container get --id="${YC_CONTAINER_ID}" --format json 2>&1)
            YC_EXIT_CODE=$?
            
            if [ $YC_EXIT_CODE -ne 0 ]; then
              echo "‚ö†Ô∏è  WARNING: yc command failed with exit code $YC_EXIT_CODE"
              echo "Output: ${CONTAINER_JSON}"
              echo "Container may not exist yet. It will be created during deployment."
              echo "BACKEND_URL=" >> $GITHUB_ENV
              exit 0
            fi

            echo "üìÑ Container JSON response:"
            echo "${CONTAINER_JSON}" | jq '.' || echo "${CONTAINER_JSON}"
            
            BACKEND_URL=$(echo "${CONTAINER_JSON}" | jq -r '.url // empty' 2>/dev/null)
            
            if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ]; then
              echo "‚ö†Ô∏è  WARNING: Container exists but URL field is empty or null"
              echo "This might mean the container hasn't been deployed yet or has no active revision"
              echo "Trying to get URL from status or other fields..."
              
              # –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å URL –∏–∑ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
              BACKEND_URL=$(echo "${CONTAINER_JSON}" | jq -r '.status.url // .current_revision.url // .url // empty' 2>/dev/null)
              
              if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ]; then
                echo "‚ö†Ô∏è  WARNING: Cannot extract backend URL from container info"
                echo "Container may not have an active revision yet. URL will be obtained after backend deployment."
                echo "BACKEND_URL=" >> $GITHUB_ENV
                exit 0
              fi
            fi
            
            echo "‚úÖ Got backend URL from container ID: ${BACKEND_URL}"
            
          elif [ -n "${YC_FOLDER_ID}" ]; then
            echo "üîç Fetching container info using folder ID and name..."
            CONTAINER_JSON=$(yc serverless container get --name=lug-date-backend --folder-id="${YC_FOLDER_ID}" --format json 2>&1)
            YC_EXIT_CODE=$?
            
            if [ $YC_EXIT_CODE -ne 0 ]; then
              echo "‚ö†Ô∏è  WARNING: yc command failed with exit code $YC_EXIT_CODE"
              echo "Output: ${CONTAINER_JSON}"
              echo "Container may not exist yet. It will be created during deployment."
              echo "BACKEND_URL=" >> $GITHUB_ENV
              exit 0
            fi

            echo "üìÑ Container JSON response:"
            echo "${CONTAINER_JSON}" | jq '.' || echo "${CONTAINER_JSON}"
            
            BACKEND_URL=$(echo "${CONTAINER_JSON}" | jq -r '.url // empty' 2>/dev/null)
            
            if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ]; then
              echo "‚ö†Ô∏è  WARNING: Container exists but URL field is empty or null"
              echo "This might mean the container hasn't been deployed yet or has no active revision"
              echo "Trying to get URL from status or other fields..."
              
              # –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å URL –∏–∑ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
              BACKEND_URL=$(echo "${CONTAINER_JSON}" | jq -r '.status.url // .current_revision.url // .url // empty' 2>/dev/null)
              
              if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ]; then
                echo "‚ö†Ô∏è  WARNING: Cannot extract backend URL from container info"
                echo "Container may not have an active revision yet. URL will be obtained after backend deployment."
                echo "BACKEND_URL=" >> $GITHUB_ENV
                exit 0
              fi
            fi
            
            echo "‚úÖ Got backend URL from folder ID: ${BACKEND_URL}"
            
          else
            echo "‚ö†Ô∏è  WARNING: Neither YC_CONTAINER_ID nor YC_FOLDER_ID is set"
            echo "BACKEND_URL will be obtained after backend deployment."
            echo "BACKEND_URL=" >> $GITHUB_ENV
            exit 0
          fi

          # Validate BACKEND_URL
          if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ] || [ "${BACKEND_URL}" == "" ]; then
            echo "‚ö†Ô∏è  WARNING: Backend URL is empty or null after extraction"
            echo "Container JSON was:"
            echo "${CONTAINER_JSON}"
            echo ""
            echo "URL will be obtained after backend deployment in the next step."
            echo "BACKEND_URL=" >> $GITHUB_ENV
            exit 0
          fi

            # Remove trailing slash from BACKEND_URL
            BACKEND_URL="${BACKEND_URL%/}"
            echo "‚úÖ Backend URL: ${BACKEND_URL}"
            echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            
          # –û–±–Ω–æ–≤–ª—è–µ–º config.js –¥–ª—è admin —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ URL –ø–æ–ª—É—á–µ–Ω
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ] && [ "${BACKEND_URL}" != "" ]; then
              printf '%s\n' \
                '// Runtime configuration for admin panel' \
                '// This file is loaded before the app starts' \
                '// You can override API URL by setting window.ADMIN_CONFIG before this script loads' \
                'window.ADMIN_CONFIG = window.ADMIN_CONFIG || {' \
                '  // Backend URL - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Yandex Serverless Containers' \
                "  API_URL: '${BACKEND_URL}'" \
                '};' > admin/public/config.js
              
              echo "‚úÖ Updated admin config.js with backend URL: ${BACKEND_URL}"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
              echo "üìÑ Config.js content:"
              cat admin/public/config.js
          else
            echo "‚ö†Ô∏è  Skipping config.js update - URL will be set after backend deployment"
          fi

      - name: Build frontend
        env:
          VITE_API_URL: ${{ env.BACKEND_URL }}
        run: |
          if [ -z "${VITE_API_URL}" ] || [ "${VITE_API_URL}" == "null" ]; then
            echo "‚ö†Ô∏è  WARNING: BACKEND_URL is not set yet."
            echo "Frontend will be built without API URL. It will be updated after backend deployment."
            echo "Building frontend with empty API URL..."
          else
            echo "‚úÖ Building frontend with API URL: ${VITE_API_URL}"
          fi
          NODE_ENV=production npm run build --workspace=frontend

      - name: Build backend
        run: NODE_ENV=production npm run build --workspace=backend

      - name: Build bot
        run: NODE_ENV=production npm run build --workspace=bot

      - name: Build admin
        run: NODE_ENV=production npm run build --workspace=admin

      - name: Ensure admin/dist exists
        run: |
          if [ ! -d "admin/dist" ]; then
            echo "‚ùå ERROR: admin/dist directory does not exist after build"
            echo "Admin build may have failed"
            exit 1
          fi
          echo "‚úÖ admin/dist directory exists"

      - name: Run database migrations
        timeout-minutes: 10
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå ERROR: DATABASE_URL is not set"
            echo "Please set DATABASE_URL in GitHub Secrets"
            exit 1
          fi

          echo "üîå Connecting to PostgreSQL..."
          echo "Database URL: ${DATABASE_URL:0:30}... (hidden for security)"
          echo ""
          echo "üöÄ Running PostgreSQL migrations..."
          NODE_ENV=production npm run migrate:postgres
        continue-on-error: false

      - name: Login to Yandex Container Registry
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # –ü—É—à–∏–º –æ–±—Ä–∞–∑
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–µ–ø–ª–æ—è
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Create container if not exists
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
          CONTAINER_CREATED=0
          if [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container create \
              --name=lug-date-backend \
              --folder-id="${YC_FOLDER_ID}" && CONTAINER_CREATED=1 || echo "Container already exists"
          else
            yc serverless container create --name=lug-date-backend && CONTAINER_CREATED=1 || echo "Container already exists"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service account, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω
          if [ "${CONTAINER_CREATED}" -eq 1 ] && [ -n "${YC_SERVICE_ACCOUNT_ID}" ]; then
            if [ -n "${YC_FOLDER_ID}" ]; then
              yc serverless container set-access-bindings \
                --name=lug-date-backend \
                --folder-id="${YC_FOLDER_ID}" \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            else
              yc serverless container set-access-bindings \
                --name=lug-date-backend \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            fi
          fi

      - name: Deploy Backend
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID: ${{ secrets.YC_CONTAINER_ID }}
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || secrets.ADMIN_TOKEN }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Set admin credentials with fallback values
          ADMIN_USERNAME="${ADMIN_USERNAME:-admin}"
          ADMIN_PASSWORD="${ADMIN_PASSWORD:-admin123}"
          ADMIN_TOKEN="${ADMIN_TOKEN:-admin-secret-token-change-in-production}"

          # Encode YC_SERVICE_ACCOUNT_KEY to base64 for safe environment variable passing
          YC_SERVICE_ACCOUNT_KEY_B64=""
          if [ -n "${YC_SERVICE_ACCOUNT_KEY:-}" ]; then
            YC_SERVICE_ACCOUNT_KEY_B64=$(printf '%s' "${YC_SERVICE_ACCOUNT_KEY}" | base64 -w 0)
            echo "‚úÖ YC_SERVICE_ACCOUNT_KEY encoded to base64 (length: ${#YC_SERVICE_ACCOUNT_KEY_B64})"
          else
            echo "‚ö†Ô∏è  WARNING: YC_SERVICE_ACCOUNT_KEY is not set"
          fi

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º container-id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏–Ω–∞—á–µ container-name —Å folder-id
          if [ -n "${YC_CONTAINER_ID}" ]; then
            yc serverless container revision deploy \
              --container-id="${YC_CONTAINER_ID}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment CONTAINER_MODE=true \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              --environment DATABASE_URL=${{ secrets.DATABASE_URL }} \
              --environment YC_SERVICE_ACCOUNT_KEY_B64="${YC_SERVICE_ACCOUNT_KEY_B64}" \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN}" \
              --environment JWT_SECRET="${ADMIN_TOKEN}"
          elif [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container revision deploy \
              --container-name=lug-date-backend \
              --folder-id="${YC_FOLDER_ID}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment CONTAINER_MODE=true \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              --environment DATABASE_URL=${{ secrets.DATABASE_URL }} \
              --environment YC_SERVICE_ACCOUNT_KEY_B64="${YC_SERVICE_ACCOUNT_KEY_B64}" \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN}" \
              --environment JWT_SECRET="${ADMIN_TOKEN}"
          else
            echo "Error: Either YC_CONTAINER_ID or YC_FOLDER_ID must be set"
            exit 1
          fi

      - name: Get Backend URL
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID: ${{ secrets.YC_CONTAINER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          echo "‚è≥ Waiting 10 seconds for container URL to be available after deployment..."
          sleep 10

          BACKEND_URL=""
          CONTAINER_JSON=""

          # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å URL —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
          MAX_ATTEMPTS=5
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "üîç Attempt $ATTEMPT/$MAX_ATTEMPTS: Fetching container info..."
            
            if [ -n "${YC_CONTAINER_ID}" ]; then
              CONTAINER_JSON=$(yc serverless container get --id="${YC_CONTAINER_ID}" --format json 2>&1)
              YC_EXIT_CODE=$?
          elif [ -n "${YC_FOLDER_ID}" ]; then
              CONTAINER_JSON=$(yc serverless container get --name=lug-date-backend --folder-id="${YC_FOLDER_ID}" --format json 2>&1)
              YC_EXIT_CODE=$?
            else
              echo "‚ùå ERROR: Neither YC_CONTAINER_ID nor YC_FOLDER_ID is set"
            exit 1
          fi

            if [ $YC_EXIT_CODE -ne 0 ]; then
              echo "‚ö†Ô∏è  Attempt $ATTEMPT failed: yc command returned exit code $YC_EXIT_CODE"
              echo "Output: ${CONTAINER_JSON}"
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå ERROR: Failed to get container info after $MAX_ATTEMPTS attempts"
                exit 1
              fi
              echo "‚è≥ Waiting 5 seconds before retry..."
              sleep 5
              ATTEMPT=$((ATTEMPT + 1))
              continue
            fi
            
            echo "üìÑ Container JSON response:"
            echo "${CONTAINER_JSON}" | jq '.' || echo "${CONTAINER_JSON}"
            
            BACKEND_URL=$(echo "${CONTAINER_JSON}" | jq -r '.url // empty' 2>/dev/null)
            
            if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ]; then
              echo "‚ö†Ô∏è  Attempt $ATTEMPT: URL field is empty, trying alternative fields..."
              BACKEND_URL=$(echo "${CONTAINER_JSON}" | jq -r '.status.url // .current_revision.url // empty' 2>/dev/null)
            fi
            
            if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ] && [ "${BACKEND_URL}" != "" ]; then
              echo "‚úÖ Successfully got backend URL on attempt $ATTEMPT"
              break
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚ö†Ô∏è  URL not available yet, waiting 5 seconds before retry..."
              sleep 5
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ -z "${BACKEND_URL}" ] || [ "${BACKEND_URL}" == "null" ] || [ "${BACKEND_URL}" == "" ]; then
            echo "‚ùå ERROR: Backend URL is still empty after $MAX_ATTEMPTS attempts"
            echo "Container JSON was:"
            echo "${CONTAINER_JSON}"
            echo ""
            echo "This might mean:"
            echo "  1. Container revision is still being created"
            echo "  2. Container has no active revision"
            echo "  3. Container URL hasn't been assigned yet"
            echo ""
            echo "Please check container status in Yandex Cloud Console"
            exit 1
          fi

          # Remove trailing slash from BACKEND_URL
          BACKEND_URL="${BACKEND_URL%/}"
            echo "‚úÖ Backend deployed: ${BACKEND_URL}"
          echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            echo "üîç Health check URL: ${BACKEND_URL}/health"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health –±–µ–∫–µ–Ω–¥–∞
            echo "‚è≥ Waiting for backend to be ready..."
            sleep 5
            
            for i in {1..10}; do
              if curl -f -s "${BACKEND_URL}/health" > /dev/null 2>&1; then
                echo "‚úÖ Backend is healthy!"
                break
              else
                echo "‚è≥ Attempt $i/10: Backend not ready yet, waiting..."
                sleep 3
              fi
            done

      - name: Deploy Frontend
        env:
          YANDEX_STORAGE_BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -z "${YANDEX_STORAGE_BUCKET}" ]; then
            echo "‚ùå Error: YANDEX_STORAGE_BUCKET secret is not set"
            echo "Please set YANDEX_STORAGE_BUCKET in GitHub Secrets"
            exit 1
          fi

          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå ERROR: frontend/dist directory does not exist"
            echo "Frontend build may have failed"
            exit 1
          fi

          echo "üì¶ Deploying frontend to bucket: ${YANDEX_STORAGE_BUCKET}"
          yc storage s3 cp \
            frontend/dist/ \
            s3://${YANDEX_STORAGE_BUCKET}/ \
            --recursive

      - name: Install AWS CLI
        run: |
          pip3 install awscli --quiet

      - name: Deploy Admin
        env:
          ADMIN_STORAGE_BUCKET: ${{ secrets.ADMIN_STORAGE_BUCKET }}
          ADMIN_STORAGE_ACCESS_KEY: ${{ secrets.ADMIN_STORAGE_ACCESS_KEY }}
          ADMIN_STORAGE_SECRET_KEY: ${{ secrets.ADMIN_STORAGE_SECRET_KEY }}
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ BACKEND_URL –¥–æ—Å—Ç—É–ø–µ–Ω
          if [ -z "${BACKEND_URL}" ]; then
            echo "‚ùå ERROR: Admin is being deployed but BACKEND_URL is not available!"
            echo "The 'Get Backend URL' step should have run and set BACKEND_URL."
            echo "Please check:"
            echo "  1. 'Get Backend URL' step executed successfully"
            echo "  2. Backend container exists and is accessible"
            echo "  3. YC_CONTAINER_ID or YC_FOLDER_ID is set in GitHub Secrets"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "${ADMIN_STORAGE_BUCKET}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_BUCKET secret is not set"
            echo "Please set ADMIN_STORAGE_BUCKET in GitHub Secrets"
            exit 1
          fi

          if [ -z "${ADMIN_STORAGE_ACCESS_KEY}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_ACCESS_KEY secret is not set"
            echo "Please set ADMIN_STORAGE_ACCESS_KEY in GitHub Secrets"
            exit 1
          fi

          if [ -z "${ADMIN_STORAGE_SECRET_KEY}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_SECRET_KEY secret is not set"
            echo "Please set ADMIN_STORAGE_SECRET_KEY in GitHub Secrets"
            exit 1
          fi

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AWS CLI –¥–ª—è Yandex Object Storage
          export AWS_ACCESS_KEY_ID="${ADMIN_STORAGE_ACCESS_KEY}"
          export AWS_SECRET_ACCESS_KEY="${ADMIN_STORAGE_SECRET_KEY}"
          export AWS_DEFAULT_REGION=ru-central1

          echo "üì¶ Deploying admin to bucket: ${ADMIN_STORAGE_BUCKET}"
          echo "üîë Using Access Key: ${ADMIN_STORAGE_ACCESS_KEY:0:10}..."

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ bucket –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          echo "üîç Checking bucket access..."
          if ! aws --endpoint-url=https://storage.yandexcloud.net s3 ls s3://${ADMIN_STORAGE_BUCKET}/ 2>&1; then
            echo "‚ùå Error: Cannot access bucket ${ADMIN_STORAGE_BUCKET}"
            echo "Please check:"
            echo "  1. Bucket name is correct: ${ADMIN_STORAGE_BUCKET}"
            echo "  2. Access Key and Secret Key are correct"
            echo "  3. Service account has permissions to access this bucket"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ admin/dist —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -d "admin/dist" ]; then
            echo "‚ùå ERROR: admin/dist directory does not exist"
            echo "Admin build may have failed"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º config.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º BACKEND_URL
          # –í–ê–ñ–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è config.js –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –î–û –¥–µ–ø–ª–æ—è
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ config.js —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π BACKEND_URL
            echo "üîç Checking config.js for current backend URL: ${BACKEND_URL}"
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é admin/public –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            mkdir -p admin/public
            
            # –û–±–Ω–æ–≤–ª—è–µ–º admin/public/config.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º URL
            printf '%s\n' \
              '// Runtime configuration for admin panel' \
              '// This file is loaded before the app starts' \
              '// You can override API URL by setting window.ADMIN_CONFIG before this script loads' \
              'window.ADMIN_CONFIG = window.ADMIN_CONFIG || {' \
              '  // Backend URL - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Yandex Serverless Containers' \
              "  API_URL: '${BACKEND_URL}'" \
              '};' > admin/public/config.js
            
            echo "‚úÖ Updated admin/public/config.js with backend URL: ${BACKEND_URL}"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –≤ dist (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏)
            cp admin/public/config.js admin/dist/config.js
            echo "‚úÖ Updated admin/dist/config.js with backend URL: ${BACKEND_URL}"
            
            echo "üìÑ Config.js content:"
            cat admin/dist/config.js
          else
              echo "‚ùå ERROR: Backend was deployed but BACKEND_URL is not available!"
              echo "This indicates a deployment failure. Please check:"
              echo "  1. Backend deployment completed successfully"
              echo "  2. 'Get Backend URL' step ran and set BACKEND_URL"
              echo "  3. Backend container exists and is accessible"
              exit 1
          fi

          # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ config.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          if [ ! -f "admin/dist/config.js" ]; then
            echo "‚ùå ERROR: config.js validation failed - file does not exist in admin/dist/"
            echo "Deployment aborted to prevent incomplete admin panel deployment."
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ config.js –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -s "admin/dist/config.js" ]; then
            echo "‚ùå ERROR: config.js is empty!"
            echo "Deployment aborted to prevent incomplete admin panel deployment."
            exit 1
          fi

          # –î–µ–ø–ª–æ–π admin –ø–∞–Ω–µ–ª–∏
          aws --endpoint-url=https://storage.yandexcloud.net s3 sync \
            admin/dist/ \
            s3://${ADMIN_STORAGE_BUCKET}/ \
            --delete

          echo "‚úÖ Admin deployed to: https://${ADMIN_STORAGE_BUCKET}.website.yandexcloud.net"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ config.js –∑–∞–¥–µ–ø–ª–æ–∏–ª—Å—è
          echo "üîç Verifying config.js deployment..."
          CONFIG_URL="https://${ADMIN_STORAGE_BUCKET}.website.yandexcloud.net/config.js"
          if curl -f -s "${CONFIG_URL}" > /dev/null 2>&1; then
            echo "‚úÖ Config.js is accessible at: ${CONFIG_URL}"
            echo "üìÑ Deployed config.js content:"
            curl -s "${CONFIG_URL}"
          else
            echo "‚ö†Ô∏è  Warning: Could not verify config.js deployment"
          fi

      - name: Deploy Bot
        env:
          YC_BOT_FUNCTION_ID: ${{ secrets.YC_BOT_FUNCTION_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Check if function ID is set
          if [ -z "${YC_BOT_FUNCTION_ID}" ]; then
            echo "‚ö†Ô∏è  Warning: YC_BOT_FUNCTION_ID is not set in GitHub Secrets"
            echo "Skipping bot deployment. To deploy bot, add YC_BOT_FUNCTION_ID to GitHub Secrets."
            exit 0
          fi

          if [ ! -d "bot/dist" ]; then
            echo "‚ùå ERROR: bot/dist directory does not exist"
            echo "Bot build may have failed"
            exit 1
          fi

          # Check bot/dist size
          BOT_SIZE=$(du -sb bot/dist | cut -f1)
          MAX_SIZE=$((3500000))

          if [ $BOT_SIZE -gt $MAX_SIZE ]; then
            echo "‚ùå Bot dist size ($BOT_SIZE bytes) exceeds 3.5 MB limit"
            exit 1
          fi

          echo "ü§ñ Deploying bot to function: ${YC_BOT_FUNCTION_ID}"
          yc serverless function version create \
            --function-id "${YC_BOT_FUNCTION_ID}" \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --environment NODE_ENV=production \
            --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}

          echo "‚úÖ Bot deployed successfully"

      - name: Health check
        env:
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: |
          echo "üîç Performing health checks..."

          # Check backend health if it was deployed
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            echo "‚è≥ Checking backend health at ${BACKEND_URL}/health..."
            echo "üîç Backend URL: ${BACKEND_URL}"
            
            # Wait longer for container to start (Yandex Cloud containers can take 30-60 seconds)
            echo "‚è≥ Waiting 30 seconds for container to start..."
            sleep 30
            
            HEALTH_CHECK_PASSED=0
            for i in {1..20}; do
              echo "‚è≥ Attempt $i/20: Checking ${BACKEND_URL}/health..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${BACKEND_URL}/health" || echo "000")
              
              if [ "${HTTP_CODE}" = "200" ]; then
                echo "‚úÖ Backend health check passed! (HTTP ${HTTP_CODE})"
                HEALTH_CHECK_PASSED=1
                break
              else
                echo "‚è≥ Attempt $i/20: Backend returned HTTP ${HTTP_CODE}, waiting..."
                sleep 5
              fi
            done
            
            if [ "${HEALTH_CHECK_PASSED}" -eq 0 ]; then
              echo "‚ùå ERROR: Backend health check failed after 20 attempts"
              echo "Backend may not be responding correctly at ${BACKEND_URL}/health"
              echo "Please check:"
              echo "  1. Container logs in Yandex Cloud Console"
              echo "  2. Container is running and healthy"
              echo "  3. Environment variables are set correctly"
              echo "  4. Database connection is working"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Backend URL not available, skipping backend health check"
          fi

          echo "‚úÖ Deployment completed successfully"
