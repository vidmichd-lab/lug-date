name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main # Production
      - develop # Staging
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Build all packages
        run: npm run build --workspace=frontend --workspace=backend --workspace=bot --workspace=admin

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: staging
      url: https://staging-api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            admin/**
            frontend/**
            backend/**
            bot/**
            shared/**

      - name: Check if force deploy all
        id: force-deploy
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–ª–∞–≥–æ–≤ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
          COMMIT_MSG=$(git log -1 --pretty=%B)
          # –î–µ–ø–ª–æ–∏–º –≤—Å–µ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ workflow
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "force_all=true" >> $GITHUB_OUTPUT
            echo "üöÄ Manual trigger detected, deploying all components"
          # –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞
          elif echo "$COMMIT_MSG" | grep -qiE "(force|deploy all|redeploy|full deploy)"; then
            echo "force_all=true" >> $GITHUB_OUTPUT
            echo "üöÄ Force deploy all components detected"
          else
            echo "force_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          if [ -n "$YC_CLOUD_ID" ]; then
            yc config set cloud-id "$YC_CLOUD_ID" || true
          fi
          if [ -n "$YC_FOLDER_ID" ]; then
            yc config set folder-id "$YC_FOLDER_ID" || true
          fi

      - name: Get Backend URL
        if: steps.changed-files.outputs.frontend == 'true' || steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_STAGING: ${{ secrets.YC_CONTAINER_ID_STAGING }}
          ADMIN_CHANGED: ${{ steps.changed-files.outputs.admin == 'true' }}
          BACKEND_CHANGED: ${{ steps.changed-files.outputs.backend == 'true' }}
          SHARED_CHANGED: ${{ steps.changed-files.outputs.shared == 'true' }}
          FORCE_ALL: ${{ steps.force-deploy.outputs.force_all == 'true' }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          echo "üîç Getting backend URL..."
          echo "YC_CONTAINER_ID_STAGING: ${YC_CONTAINER_ID_STAGING:0:20}..."
          echo "YC_FOLDER_ID: ${YC_FOLDER_ID}"

          if [ -n "${YC_CONTAINER_ID_STAGING}" ]; then
            BACKEND_URL=$(yc serverless container get --id="${YC_CONTAINER_ID_STAGING}" --format json | jq -r '.url')
            echo "‚úÖ Got backend URL from container ID: ${BACKEND_URL}"
          elif [ -n "${YC_FOLDER_ID}" ]; then
            BACKEND_URL=$(yc serverless container get --name=lug-date-backend-staging --folder-id="${YC_FOLDER_ID}" --format json | jq -r '.url')
            echo "‚úÖ Got backend URL from folder ID: ${BACKEND_URL}"
          else
            echo "‚ö†Ô∏è  WARNING: Cannot get backend URL - neither YC_CONTAINER_ID_STAGING nor YC_FOLDER_ID is set"
            echo "This step will continue, but downstream steps that require BACKEND_URL may fail."
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_STAGING or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            # Don't exit - let downstream steps handle the missing BACKEND_URL
          fi

          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            # Remove trailing slash from BACKEND_URL
            BACKEND_URL="${BACKEND_URL%/}"
            echo "‚úÖ Backend URL: ${BACKEND_URL}"
            echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            
            # –û–±–Ω–æ–≤–ª—è–µ–º config.js —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è admin (admin/backend/shared –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
            if [ "${ADMIN_CHANGED}" == "true" ] || [ "${BACKEND_CHANGED}" == "true" ] || [ "${SHARED_CHANGED}" == "true" ] || [ "${FORCE_ALL}" == "true" ]; then
              printf '%s\n' \
                '// Runtime configuration for admin panel' \
                '// This file is loaded before the app starts' \
                '// You can override API URL by setting window.ADMIN_CONFIG before this script loads' \
                'window.ADMIN_CONFIG = window.ADMIN_CONFIG || {' \
                '  // Backend URL - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Yandex Serverless Containers' \
                "  API_URL: '${BACKEND_URL}'" \
                '};' > admin/public/config.js
              
              echo "‚úÖ Updated admin config.js with backend URL: ${BACKEND_URL}"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
              echo "üìÑ Config.js content:"
              cat admin/public/config.js
            fi
          else
            echo "‚ö†Ô∏è  WARNING: Backend URL not available! Frontend and admin panel may not work."
            echo "This step will continue, but downstream steps that require BACKEND_URL may fail."
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_STAGING or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            # Don't exit - let downstream steps handle the missing BACKEND_URL
          fi

      - name: Build frontend
        if: steps.changed-files.outputs.frontend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          VITE_API_URL: ${{ env.BACKEND_URL }}
        run: NODE_ENV=development npm run build --workspace=frontend

      - name: Build backend
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: NODE_ENV=development npm run build --workspace=backend

      - name: Build bot
        if: steps.changed-files.outputs.bot == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: NODE_ENV=development npm run build --workspace=bot

      - name: Build admin
        if: steps.changed-files.outputs.admin == 'true' || steps.changed-files.outputs.shared == 'true' || steps.changed-files.outputs.backend == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: NODE_ENV=development npm run build --workspace=admin

      - name: Run database migrations
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          NODE_ENV=development YDB_ENDPOINT_DEV=${{ secrets.YDB_ENDPOINT_DEV }} YDB_DATABASE_DEV=${{ secrets.YDB_DATABASE_DEV }} npm run migrate || echo "‚ö†Ô∏è Migrations skipped"
        continue-on-error: true

      - name: Login to Yandex Container Registry
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # –ü—É—à–∏–º –æ–±—Ä–∞–∑
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–µ–ø–ª–æ—è
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Create container if not exists
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
          CONTAINER_CREATED=0
          if [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container create \
              --name=lug-date-backend-staging \
              --folder-id="${YC_FOLDER_ID}" && CONTAINER_CREATED=1 || echo "Container already exists"
          else
            yc serverless container create --name=lug-date-backend-staging && CONTAINER_CREATED=1 || echo "Container already exists"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service account, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω
          if [ "${CONTAINER_CREATED}" -eq 1 ] && [ -n "${YC_SERVICE_ACCOUNT_ID}" ]; then
            if [ -n "${YC_FOLDER_ID}" ]; then
              yc serverless container set-access-bindings \
                --name=lug-date-backend-staging \
                --folder-id="${YC_FOLDER_ID}" \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            else
              yc serverless container set-access-bindings \
                --name=lug-date-backend-staging \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            fi
          fi

      - name: Deploy Backend
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_STAGING: ${{ secrets.YC_CONTAINER_ID_STAGING }}
          ADMIN_USERNAME_DEV: ${{ secrets.ADMIN_USERNAME_DEV }}
          ADMIN_PASSWORD_DEV: ${{ secrets.ADMIN_PASSWORD_DEV }}
          ADMIN_TOKEN_DEV: ${{ secrets.ADMIN_TOKEN_DEV }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Set admin credentials with fallback values
          ADMIN_USERNAME="${ADMIN_USERNAME_DEV:-admin}"
          ADMIN_PASSWORD="${ADMIN_PASSWORD_DEV:-admin123}"
          ADMIN_TOKEN="${ADMIN_TOKEN_DEV:-admin-secret-token-change-in-production}"

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º container-id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏–Ω–∞—á–µ container-name —Å folder-id
          if [ -n "${YC_CONTAINER_ID_STAGING}" ]; then
            yc serverless container revision deploy \
              --container-id="${YC_CONTAINER_ID_STAGING}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=development \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS_DEV }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS_DEV }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN}"
          elif [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container revision deploy \
              --container-name=lug-date-backend-staging \
              --folder-id="${YC_FOLDER_ID}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=development \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS_DEV }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS_DEV }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN}"
          else
            echo "Error: Either YC_CONTAINER_ID_STAGING or YC_FOLDER_ID must be set"
            exit 1
          fi

      - name: Get Backend URL
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_STAGING: ${{ secrets.YC_CONTAINER_ID_STAGING }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -n "${YC_CONTAINER_ID_STAGING}" ]; then
            BACKEND_URL=$(yc serverless container get --id="${YC_CONTAINER_ID_STAGING}" --format json | jq -r '.url')
          elif [ -n "${YC_FOLDER_ID}" ]; then
            BACKEND_URL=$(yc serverless container get --name=lug-date-backend-staging --folder-id="${YC_FOLDER_ID}" --format json | jq -r '.url')
          else
            echo "‚ùå ERROR: Cannot get backend URL - neither YC_CONTAINER_ID_STAGING nor YC_FOLDER_ID is set"
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_STAGING or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            # Remove trailing slash from BACKEND_URL
            BACKEND_URL="${BACKEND_URL%/}"
            echo "‚úÖ Backend deployed: ${BACKEND_URL}"
            echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            echo "üîç Health check: ${BACKEND_URL}/health"
          else
            echo "‚ùå ERROR: Backend URL is empty or null"
            echo "Please check:"
            echo "  1. Backend container exists in Yandex Cloud"
            echo "  2. Container has been deployed successfully"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

      - name: Deploy Frontend
        if: steps.changed-files.outputs.frontend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YANDEX_STORAGE_BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_DEV }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -z "${YANDEX_STORAGE_BUCKET}" ]; then
            echo "‚ùå Error: YANDEX_STORAGE_BUCKET_DEV secret is not set"
            echo "Please set YANDEX_STORAGE_BUCKET_DEV in GitHub Secrets for staging environment"
            exit 1
          fi

          echo "üì¶ Deploying frontend to bucket: ${YANDEX_STORAGE_BUCKET}"
          yc storage s3 cp \
            frontend/dist/ \
            s3://${YANDEX_STORAGE_BUCKET}/ \
            --recursive

      - name: Install AWS CLI
        if: steps.changed-files.outputs.admin == 'true' || steps.changed-files.outputs.shared == 'true' || steps.changed-files.outputs.backend == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: |
          pip3 install awscli --quiet

      - name: Deploy Admin
        if: steps.changed-files.outputs.admin == 'true' || steps.changed-files.outputs.shared == 'true' || steps.changed-files.outputs.backend == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          ADMIN_STORAGE_BUCKET: ${{ secrets.ADMIN_STORAGE_BUCKET_DEV }}
          ADMIN_STORAGE_ACCESS_KEY: ${{ secrets.ADMIN_STORAGE_ACCESS_KEY_DEV }}
          ADMIN_STORAGE_SECRET_KEY: ${{ secrets.ADMIN_STORAGE_SECRET_KEY_DEV }}
          BACKEND_URL: ${{ env.BACKEND_URL }}
          BACKEND_CHANGED: ${{ steps.changed-files.outputs.backend == 'true' }}
          ADMIN_CHANGED: ${{ steps.changed-files.outputs.admin == 'true' }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ BACKEND_URL –¥–æ—Å—Ç—É–ø–µ–Ω, –µ—Å–ª–∏ admin —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç—Å—è
          # "Get Backend URL" step –¥–æ–ª–∂–µ–Ω –±—ã–ª –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —à–∞–≥–æ–º
          if [ "${ADMIN_CHANGED}" == "true" ] && [ -z "${BACKEND_URL}" ]; then
            echo "‚ùå ERROR: Admin is being deployed but BACKEND_URL is not available!"
            echo "The 'Get Backend URL' step should have run and set BACKEND_URL."
            echo "This indicates a workflow configuration issue or the step failed silently."
            echo "Please check:"
            echo "  1. 'Get Backend URL' step executed successfully"
            echo "  2. Backend container exists and is accessible"
            echo "  3. YC_CONTAINER_ID_STAGING or YC_FOLDER_ID is set in GitHub Secrets"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "${ADMIN_STORAGE_BUCKET}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_BUCKET_DEV secret is not set"
            echo "Please set ADMIN_STORAGE_BUCKET_DEV in GitHub Secrets for staging environment"
            exit 1
          fi

          if [ -z "${ADMIN_STORAGE_ACCESS_KEY}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_ACCESS_KEY_DEV secret is not set"
            echo "Please set ADMIN_STORAGE_ACCESS_KEY_DEV in GitHub Secrets for staging environment"
            exit 1
          fi

          if [ -z "${ADMIN_STORAGE_SECRET_KEY}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_SECRET_KEY_DEV secret is not set"
            echo "Please set ADMIN_STORAGE_SECRET_KEY_DEV in GitHub Secrets for staging environment"
            exit 1
          fi

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AWS CLI –¥–ª—è Yandex Object Storage
          export AWS_ACCESS_KEY_ID="${ADMIN_STORAGE_ACCESS_KEY}"
          export AWS_SECRET_ACCESS_KEY="${ADMIN_STORAGE_SECRET_KEY}"
          export AWS_DEFAULT_REGION=ru-central1

          echo "üì¶ Deploying admin to bucket: ${ADMIN_STORAGE_BUCKET}"
          echo "üîë Using Access Key: ${ADMIN_STORAGE_ACCESS_KEY:0:10}..."

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ bucket –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          echo "üîç Checking bucket access..."
          if ! aws --endpoint-url=https://storage.yandexcloud.net s3 ls s3://${ADMIN_STORAGE_BUCKET}/ 2>&1; then
            echo "‚ùå Error: Cannot access bucket ${ADMIN_STORAGE_BUCKET}"
            echo "Please check:"
            echo "  1. Bucket name is correct: ${ADMIN_STORAGE_BUCKET}"
            echo "  2. Access Key and Secret Key are correct"
            echo "  3. Service account has permissions to access this bucket"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º config.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º BACKEND_URL
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ config.js —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π BACKEND_URL
            echo "üîç Checking config.js for current backend URL: ${BACKEND_URL}"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º admin/public/config.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º URL
            printf '%s\n' \
              '// Runtime configuration for admin panel' \
              '// This file is loaded before the app starts' \
              '// You can override API URL by setting window.ADMIN_CONFIG before this script loads' \
              'window.ADMIN_CONFIG = window.ADMIN_CONFIG || {' \
              '  // Backend URL - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Yandex Serverless Containers' \
              "  API_URL: '${BACKEND_URL}'" \
              '};' > admin/public/config.js
            
            echo "‚úÖ Updated admin/public/config.js with backend URL: ${BACKEND_URL}"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –≤ dist –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
            cp admin/public/config.js admin/dist/config.js
            echo "‚úÖ Updated admin/dist/config.js with backend URL: ${BACKEND_URL}"
            
            echo "üìÑ Config.js content:"
            cat admin/dist/config.js
          else
            # –ï—Å–ª–∏ BACKEND_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π config.js
            # –ï—Å–ª–∏ backend –±—ã–ª —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ —ç—Ç–æ–º –∑–∞–ø—É—Å–∫–µ, BACKEND_URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω
            if [ "${BACKEND_CHANGED}" == "true" ]; then
              echo "‚ùå ERROR: Backend was deployed but BACKEND_URL is not available!"
              echo "This indicates a deployment failure. Please check:"
              echo "  1. Backend deployment completed successfully"
              echo "  2. 'Get Backend URL' step ran and set BACKEND_URL"
              echo "  3. Backend container exists and is accessible"
              exit 1
            fi
            
            # –ï—Å–ª–∏ backend –Ω–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–ª—Å—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π config.js
            if [ ! -f "admin/dist/config.js" ]; then
              echo "‚ö†Ô∏è  Warning: config.js not found in admin/dist, checking if it exists in admin/public..."
              if [ -f "admin/public/config.js" ]; then
                echo "üìã Config.js exists in public, copying to dist..."
                cp admin/public/config.js admin/dist/config.js
                echo "‚ö†Ô∏è  Warning: Using existing config.js without current BACKEND_URL. This may contain stale backend URL."
              else
                echo "‚ùå ERROR: config.js not found in admin/public either!"
                echo "config.js is required for admin panel to work."
                echo "Please ensure:"
                echo "  1. Backend is deployed and BACKEND_URL is available, OR"
                echo "  2. admin/public/config.js exists with a valid backend URL"
                exit 1
              fi
            else
              echo "‚úÖ Config.js found in admin/dist"
              echo "‚ö†Ô∏è  Warning: BACKEND_URL not set, using existing config.js which may contain stale backend URL."
            fi
            echo "üìÑ Config.js content:"
            cat admin/dist/config.js
          fi

          # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ config.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          if [ ! -f "admin/dist/config.js" ]; then
            echo "‚ùå ERROR: config.js validation failed - file does not exist in admin/dist/"
            echo "Deployment aborted to prevent incomplete admin panel deployment."
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ config.js –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -s "admin/dist/config.js" ]; then
            echo "‚ùå ERROR: config.js is empty!"
            echo "Deployment aborted to prevent incomplete admin panel deployment."
            exit 1
          fi

          # –î–µ–ø–ª–æ–π admin –ø–∞–Ω–µ–ª–∏
          aws --endpoint-url=https://storage.yandexcloud.net s3 sync \
            admin/dist/ \
            s3://${ADMIN_STORAGE_BUCKET}/ \
            --delete

          echo "‚úÖ Admin deployed to: https://${ADMIN_STORAGE_BUCKET}.website.yandexcloud.net"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ config.js –∑–∞–¥–µ–ø–ª–æ–∏–ª—Å—è
          echo "üîç Verifying config.js deployment..."
          CONFIG_URL="https://${ADMIN_STORAGE_BUCKET}.website.yandexcloud.net/config.js"
          if curl -f -s "${CONFIG_URL}" > /dev/null 2>&1; then
            echo "‚úÖ Config.js is accessible at: ${CONFIG_URL}"
            echo "üìÑ Deployed config.js content:"
            curl -s "${CONFIG_URL}"
          else
            echo "‚ö†Ô∏è  Warning: Could not verify config.js deployment"
          fi

      - name: Deploy Bot
        if: steps.changed-files.outputs.bot == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_BOT_FUNCTION_ID: ${{ secrets.YC_BOT_FUNCTION_ID_STAGING }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Check if function ID is set
          if [ -z "${YC_BOT_FUNCTION_ID}" ]; then
            echo "‚ö†Ô∏è  Warning: YC_BOT_FUNCTION_ID_STAGING is not set in GitHub Secrets"
            echo "Skipping bot deployment. To deploy bot, add YC_BOT_FUNCTION_ID_STAGING to GitHub Secrets."
            exit 0
          fi

          # Check bot/dist size
          BOT_SIZE=$(du -sb bot/dist | cut -f1)
          MAX_SIZE=$((3500000))

          if [ $BOT_SIZE -gt $MAX_SIZE ]; then
            echo "‚ùå Bot dist size ($BOT_SIZE bytes) exceeds 3.5 MB limit"
            exit 1
          fi

          echo "ü§ñ Deploying bot to function: ${YC_BOT_FUNCTION_ID}"
          yc serverless function version create \
            --function-id "${YC_BOT_FUNCTION_ID}" \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --environment NODE_ENV=development \
            --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }}

          echo "‚úÖ Bot deployed successfully"

      - name: Health check
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: |
          echo "üîç Performing health checks..."

          # Check backend health if it was deployed
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            echo "‚è≥ Checking backend health at ${BACKEND_URL}/health..."
            echo "üîç Backend URL: ${BACKEND_URL}"
            
            # Wait longer for container to start (Yandex Cloud containers can take 30-60 seconds)
            echo "‚è≥ Waiting 30 seconds for container to start..."
            sleep 30
            
            HEALTH_CHECK_PASSED=0
            for i in {1..20}; do
              echo "‚è≥ Attempt $i/20: Checking ${BACKEND_URL}/health..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${BACKEND_URL}/health" || echo "000")
              
              if [ "${HTTP_CODE}" = "200" ]; then
                echo "‚úÖ Backend health check passed! (HTTP ${HTTP_CODE})"
                HEALTH_CHECK_PASSED=1
                break
              else
                echo "‚è≥ Attempt $i/20: Backend returned HTTP ${HTTP_CODE}, waiting..."
                sleep 5
              fi
            done
            
            if [ "${HEALTH_CHECK_PASSED}" -eq 0 ]; then
              echo "‚ùå ERROR: Backend health check failed after 20 attempts"
              echo "Backend may not be responding correctly at ${BACKEND_URL}/health"
              echo "Please check:"
              echo "  1. Container logs in Yandex Cloud Console"
              echo "  2. Container is running and healthy"
              echo "  3. Environment variables are set correctly"
              echo "  4. Database connection is working"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Backend URL not available, skipping backend health check"
          fi

          echo "‚úÖ Staging deployment completed successfully"

  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production
      url: https://api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            admin/**
            frontend/**
            backend/**
            bot/**
            shared/**

      - name: Check if force deploy all
        id: force-deploy
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–ª–∞–≥–æ–≤ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
          COMMIT_MSG=$(git log -1 --pretty=%B)
          # –î–µ–ø–ª–æ–∏–º –≤—Å–µ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ workflow
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "force_all=true" >> $GITHUB_OUTPUT
            echo "üöÄ Manual trigger detected, deploying all components"
          # –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞
          elif echo "$COMMIT_MSG" | grep -qiE "(force|deploy all|redeploy|full deploy)"; then
            echo "force_all=true" >> $GITHUB_OUTPUT
            echo "üöÄ Force deploy all components detected"
          else
            echo "force_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          if [ -n "$YC_CLOUD_ID" ]; then
            yc config set cloud-id "$YC_CLOUD_ID" || true
          fi
          if [ -n "$YC_FOLDER_ID" ]; then
            yc config set folder-id "$YC_FOLDER_ID" || true
          fi

      - name: Get Backend URL
        if: steps.changed-files.outputs.frontend == 'true' || steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_PROD: ${{ secrets.YC_CONTAINER_ID_PROD }}
          ADMIN_CHANGED: ${{ steps.changed-files.outputs.admin == 'true' }}
          BACKEND_CHANGED: ${{ steps.changed-files.outputs.backend == 'true' }}
          SHARED_CHANGED: ${{ steps.changed-files.outputs.shared == 'true' }}
          FORCE_ALL: ${{ steps.force-deploy.outputs.force_all == 'true' }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          echo "üîç Getting backend URL..."
          echo "YC_CONTAINER_ID_PROD: ${YC_CONTAINER_ID_PROD:0:20}..."
          echo "YC_FOLDER_ID: ${YC_FOLDER_ID}"

          if [ -n "${YC_CONTAINER_ID_PROD}" ]; then
            BACKEND_URL=$(yc serverless container get --id="${YC_CONTAINER_ID_PROD}" --format json | jq -r '.url')
            echo "‚úÖ Got backend URL from container ID: ${BACKEND_URL}"
          elif [ -n "${YC_FOLDER_ID}" ]; then
            BACKEND_URL=$(yc serverless container get --name=lug-date-backend-prod --folder-id="${YC_FOLDER_ID}" --format json | jq -r '.url')
            echo "‚úÖ Got backend URL from folder ID: ${BACKEND_URL}"
          else
            echo "‚ö†Ô∏è  WARNING: Cannot get backend URL - neither YC_CONTAINER_ID_PROD nor YC_FOLDER_ID is set"
            echo "This step will continue, but downstream steps that require BACKEND_URL may fail."
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_PROD or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            # Don't exit - let downstream steps handle the missing BACKEND_URL
          fi

          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            # Remove trailing slash from BACKEND_URL
            BACKEND_URL="${BACKEND_URL%/}"
            echo "‚úÖ Backend URL: ${BACKEND_URL}"
            echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            
            # –û–±–Ω–æ–≤–ª—è–µ–º config.js —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è admin (admin/backend/shared –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
            if [ "${ADMIN_CHANGED}" == "true" ] || [ "${BACKEND_CHANGED}" == "true" ] || [ "${SHARED_CHANGED}" == "true" ] || [ "${FORCE_ALL}" == "true" ]; then
              printf '%s\n' \
                '// Runtime configuration for admin panel' \
                '// This file is loaded before the app starts' \
                '// You can override API URL by setting window.ADMIN_CONFIG before this script loads' \
                'window.ADMIN_CONFIG = window.ADMIN_CONFIG || {' \
                '  // Backend URL - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Yandex Serverless Containers' \
                "  API_URL: '${BACKEND_URL}'" \
                '};' > admin/public/config.js
              
              echo "‚úÖ Updated admin config.js with backend URL: ${BACKEND_URL}"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
              echo "üìÑ Config.js content:"
              cat admin/public/config.js
            fi
          else
            echo "‚ö†Ô∏è  WARNING: Backend URL not available! Frontend and admin panel may not work."
            echo "This step will continue, but downstream steps that require BACKEND_URL may fail."
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_PROD or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            # Don't exit - let downstream steps handle the missing BACKEND_URL
          fi

      - name: Build frontend
        if: steps.changed-files.outputs.frontend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          VITE_API_URL: ${{ env.BACKEND_URL }}
        run: NODE_ENV=production npm run build --workspace=frontend

      - name: Build backend
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: NODE_ENV=production npm run build --workspace=backend

      - name: Build bot
        if: steps.changed-files.outputs.bot == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: NODE_ENV=production npm run build --workspace=bot

      - name: Build admin
        if: steps.changed-files.outputs.admin == 'true' || steps.changed-files.outputs.shared == 'true' || steps.changed-files.outputs.backend == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: NODE_ENV=production npm run build --workspace=admin

      - name: Run database migrations
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          NODE_ENV=production YDB_ENDPOINT_PROD=${{ secrets.YDB_ENDPOINT_PROD }} YDB_DATABASE_PROD=${{ secrets.YDB_DATABASE_PROD }} npm run migrate
        continue-on-error: true

      - name: Login to Yandex Container Registry
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # –ü—É—à–∏–º –æ–±—Ä–∞–∑
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–µ–ø–ª–æ—è
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Create container if not exists
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
          CONTAINER_CREATED=0
          if [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container create \
              --name=lug-date-backend-prod \
              --folder-id="${YC_FOLDER_ID}" && CONTAINER_CREATED=1 || echo "Container already exists"
          else
            yc serverless container create --name=lug-date-backend-prod && CONTAINER_CREATED=1 || echo "Container already exists"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service account, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω
          if [ "${CONTAINER_CREATED}" -eq 1 ] && [ -n "${YC_SERVICE_ACCOUNT_ID}" ]; then
            if [ -n "${YC_FOLDER_ID}" ]; then
              yc serverless container set-access-bindings \
                --name=lug-date-backend-prod \
                --folder-id="${YC_FOLDER_ID}" \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            else
              yc serverless container set-access-bindings \
                --name=lug-date-backend-prod \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            fi
          fi

      - name: Deploy Backend
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_PROD: ${{ secrets.YC_CONTAINER_ID_PROD }}
          ADMIN_USERNAME_PROD: ${{ secrets.ADMIN_USERNAME_PROD }}
          ADMIN_PASSWORD_PROD: ${{ secrets.ADMIN_PASSWORD_PROD }}
          ADMIN_TOKEN_PROD: ${{ secrets.ADMIN_TOKEN_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Set admin credentials with fallback values
          ADMIN_USERNAME="${ADMIN_USERNAME_PROD:-admin}"
          ADMIN_PASSWORD="${ADMIN_PASSWORD_PROD:-admin123}"
          ADMIN_TOKEN="${ADMIN_TOKEN_PROD:-admin-secret-token-change-in-production}"

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º container-id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏–Ω–∞—á–µ container-name —Å folder-id
          if [ -n "${YC_CONTAINER_ID_PROD}" ]; then
            yc serverless container revision deploy \
              --container-id="${YC_CONTAINER_ID_PROD}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS_PROD }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS_PROD }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN}"
          elif [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container revision deploy \
              --container-name=lug-date-backend-prod \
              --folder-id="${YC_FOLDER_ID}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS_PROD }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS_PROD }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN}"
          else
            echo "Error: Either YC_CONTAINER_ID_PROD or YC_FOLDER_ID must be set"
            exit 1
          fi

      - name: Get Backend URL
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_PROD: ${{ secrets.YC_CONTAINER_ID_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -n "${YC_CONTAINER_ID_PROD}" ]; then
            BACKEND_URL=$(yc serverless container get --id="${YC_CONTAINER_ID_PROD}" --format json | jq -r '.url')
          elif [ -n "${YC_FOLDER_ID}" ]; then
            BACKEND_URL=$(yc serverless container get --name=lug-date-backend-prod --folder-id="${YC_FOLDER_ID}" --format json | jq -r '.url')
          else
            echo "‚ùå ERROR: Cannot get backend URL - neither YC_CONTAINER_ID_PROD nor YC_FOLDER_ID is set"
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_PROD or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            echo "‚úÖ Backend deployed: ${BACKEND_URL}"
            echo "üîç Health check URL: ${BACKEND_URL}/health"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health –±–µ–∫–µ–Ω–¥–∞
            echo "‚è≥ Waiting for backend to be ready..."
            sleep 5
            
            for i in {1..10}; do
              if curl -f -s "${BACKEND_URL}/health" > /dev/null 2>&1; then
                echo "‚úÖ Backend is healthy!"
                break
              else
                echo "‚è≥ Attempt $i/10: Backend not ready yet, waiting..."
                sleep 3
              fi
            done
          else
            echo "‚ùå ERROR: Backend URL is empty or null"
            echo "Please check:"
            echo "  1. Backend container exists in Yandex Cloud"
            echo "  2. Container has been deployed successfully"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

      - name: Deploy Frontend
        if: steps.changed-files.outputs.frontend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YANDEX_STORAGE_BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -z "${YANDEX_STORAGE_BUCKET}" ]; then
            echo "‚ùå Error: YANDEX_STORAGE_BUCKET_PROD secret is not set"
            echo "Please set YANDEX_STORAGE_BUCKET_PROD in GitHub Secrets for production environment"
            exit 1
          fi

          echo "üì¶ Deploying frontend to bucket: ${YANDEX_STORAGE_BUCKET}"
          yc storage s3 cp \
            frontend/dist/ \
            s3://${YANDEX_STORAGE_BUCKET}/ \
            --recursive

      - name: Install AWS CLI
        if: steps.changed-files.outputs.admin == 'true' || steps.changed-files.outputs.shared == 'true' || steps.changed-files.outputs.backend == 'true' || steps.force-deploy.outputs.force_all == 'true'
        run: |
          pip3 install awscli --quiet

      - name: Deploy Admin
        if: steps.changed-files.outputs.admin == 'true' || steps.changed-files.outputs.shared == 'true' || steps.changed-files.outputs.backend == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          ADMIN_STORAGE_BUCKET: ${{ secrets.ADMIN_STORAGE_BUCKET_PROD }}
          ADMIN_STORAGE_ACCESS_KEY: ${{ secrets.ADMIN_STORAGE_ACCESS_KEY_PROD }}
          ADMIN_STORAGE_SECRET_KEY: ${{ secrets.ADMIN_STORAGE_SECRET_KEY_PROD }}
          BACKEND_URL: ${{ env.BACKEND_URL }}
          BACKEND_CHANGED: ${{ steps.changed-files.outputs.backend == 'true' }}
          ADMIN_CHANGED: ${{ steps.changed-files.outputs.admin == 'true' }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ BACKEND_URL –¥–æ—Å—Ç—É–ø–µ–Ω, –µ—Å–ª–∏ admin —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç—Å—è
          # "Get Backend URL" step –¥–æ–ª–∂–µ–Ω –±—ã–ª –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —à–∞–≥–æ–º
          if [ "${ADMIN_CHANGED}" == "true" ] && [ -z "${BACKEND_URL}" ]; then
            echo "‚ùå ERROR: Admin is being deployed but BACKEND_URL is not available!"
            echo "The 'Get Backend URL' step should have run and set BACKEND_URL."
            echo "This indicates a workflow configuration issue or the step failed silently."
            echo "Please check:"
            echo "  1. 'Get Backend URL' step executed successfully"
            echo "  2. Backend container exists and is accessible"
            echo "  3. YC_CONTAINER_ID_PROD or YC_FOLDER_ID is set in GitHub Secrets"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "${ADMIN_STORAGE_BUCKET}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_BUCKET_PROD secret is not set"
            echo "Please set ADMIN_STORAGE_BUCKET_PROD in GitHub Secrets for production environment"
            exit 1
          fi

          if [ -z "${ADMIN_STORAGE_ACCESS_KEY}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_ACCESS_KEY_PROD secret is not set"
            echo "Please set ADMIN_STORAGE_ACCESS_KEY_PROD in GitHub Secrets for production environment"
            exit 1
          fi

          if [ -z "${ADMIN_STORAGE_SECRET_KEY}" ]; then
            echo "‚ùå Error: ADMIN_STORAGE_SECRET_KEY_PROD secret is not set"
            echo "Please set ADMIN_STORAGE_SECRET_KEY_PROD in GitHub Secrets for production environment"
            exit 1
          fi

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AWS CLI –¥–ª—è Yandex Object Storage
          export AWS_ACCESS_KEY_ID="${ADMIN_STORAGE_ACCESS_KEY}"
          export AWS_SECRET_ACCESS_KEY="${ADMIN_STORAGE_SECRET_KEY}"
          export AWS_DEFAULT_REGION=ru-central1

          echo "üì¶ Deploying admin to bucket: ${ADMIN_STORAGE_BUCKET}"
          echo "üîë Using Access Key: ${ADMIN_STORAGE_ACCESS_KEY:0:10}..."

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ bucket –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          echo "üîç Checking bucket access..."
          if ! aws --endpoint-url=https://storage.yandexcloud.net s3 ls s3://${ADMIN_STORAGE_BUCKET}/ 2>&1; then
            echo "‚ùå Error: Cannot access bucket ${ADMIN_STORAGE_BUCKET}"
            echo "Please check:"
            echo "  1. Bucket name is correct: ${ADMIN_STORAGE_BUCKET}"
            echo "  2. Access Key and Secret Key are correct"
            echo "  3. Service account has permissions to access this bucket"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º config.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º BACKEND_URL
          # –í–ê–ñ–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è config.js –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –î–û –¥–µ–ø–ª–æ—è
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ config.js —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π BACKEND_URL
            echo "üîç Checking config.js for current backend URL: ${BACKEND_URL}"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º admin/public/config.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º URL
            printf '%s\n' \
              '// Runtime configuration for admin panel' \
              '// This file is loaded before the app starts' \
              '// You can override API URL by setting window.ADMIN_CONFIG before this script loads' \
              'window.ADMIN_CONFIG = window.ADMIN_CONFIG || {' \
              '  // Backend URL - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Yandex Serverless Containers' \
              "  API_URL: '${BACKEND_URL}'" \
              '};' > admin/public/config.js
            
            echo "‚úÖ Updated admin/public/config.js with backend URL: ${BACKEND_URL}"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –≤ dist –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
            cp admin/public/config.js admin/dist/config.js
            echo "‚úÖ Updated admin/dist/config.js with backend URL: ${BACKEND_URL}"
            
            echo "üìÑ Config.js content:"
            cat admin/dist/config.js
          else
            # –ï—Å–ª–∏ BACKEND_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π config.js
            # –ï—Å–ª–∏ backend –±—ã–ª —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ —ç—Ç–æ–º –∑–∞–ø—É—Å–∫–µ, BACKEND_URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω
            if [ "${BACKEND_CHANGED}" == "true" ]; then
              echo "‚ùå ERROR: Backend was deployed but BACKEND_URL is not available!"
              echo "This indicates a deployment failure. Please check:"
              echo "  1. Backend deployment completed successfully"
              echo "  2. 'Get Backend URL' step ran and set BACKEND_URL"
              echo "  3. Backend container exists and is accessible"
              exit 1
            fi
            
            # –ï—Å–ª–∏ backend –Ω–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–ª—Å—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π config.js
            if [ ! -f "admin/dist/config.js" ]; then
              echo "‚ö†Ô∏è  Warning: config.js not found in admin/dist, checking if it exists in admin/public..."
              if [ -f "admin/public/config.js" ]; then
                echo "üìã Config.js exists in public, copying to dist..."
                cp admin/public/config.js admin/dist/config.js
                echo "‚ö†Ô∏è  Warning: Using existing config.js without current BACKEND_URL. This may contain stale backend URL."
              else
                echo "‚ùå ERROR: config.js not found in admin/public either!"
                echo "config.js is required for admin panel to work."
                echo "Please ensure:"
                echo "  1. Backend is deployed and BACKEND_URL is available, OR"
                echo "  2. admin/public/config.js exists with a valid backend URL"
                exit 1
              fi
            else
              echo "‚úÖ Config.js found in admin/dist"
              echo "‚ö†Ô∏è  Warning: BACKEND_URL not set, using existing config.js which may contain stale backend URL."
            fi
            echo "üìÑ Config.js content:"
            cat admin/dist/config.js
          fi

          # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ config.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          if [ ! -f "admin/dist/config.js" ]; then
            echo "‚ùå ERROR: config.js validation failed - file does not exist in admin/dist/"
            echo "Deployment aborted to prevent incomplete admin panel deployment."
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ config.js –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -s "admin/dist/config.js" ]; then
            echo "‚ùå ERROR: config.js is empty!"
            echo "Deployment aborted to prevent incomplete admin panel deployment."
            exit 1
          fi

          # –î–µ–ø–ª–æ–π admin –ø–∞–Ω–µ–ª–∏
          aws --endpoint-url=https://storage.yandexcloud.net s3 sync \
            admin/dist/ \
            s3://${ADMIN_STORAGE_BUCKET}/ \
            --delete

          echo "‚úÖ Admin deployed to: https://${ADMIN_STORAGE_BUCKET}.website.yandexcloud.net"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ config.js –∑–∞–¥–µ–ø–ª–æ–∏–ª—Å—è
          echo "üîç Verifying config.js deployment..."
          CONFIG_URL="https://${ADMIN_STORAGE_BUCKET}.website.yandexcloud.net/config.js"
          if curl -f -s "${CONFIG_URL}" > /dev/null 2>&1; then
            echo "‚úÖ Config.js is accessible at: ${CONFIG_URL}"
            echo "üìÑ Deployed config.js content:"
            curl -s "${CONFIG_URL}"
          else
            echo "‚ö†Ô∏è  Warning: Could not verify config.js deployment"
          fi

      - name: Deploy Bot
        if: steps.changed-files.outputs.bot == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          YC_BOT_FUNCTION_ID: ${{ secrets.YC_BOT_FUNCTION_ID_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Check if function ID is set
          if [ -z "${YC_BOT_FUNCTION_ID}" ]; then
            echo "‚ö†Ô∏è  Warning: YC_BOT_FUNCTION_ID_PROD is not set in GitHub Secrets"
            echo "Skipping bot deployment. To deploy bot, add YC_BOT_FUNCTION_ID_PROD to GitHub Secrets."
            exit 0
          fi

          # Check bot/dist size
          BOT_SIZE=$(du -sb bot/dist | cut -f1)
          MAX_SIZE=$((3500000))

          if [ $BOT_SIZE -gt $MAX_SIZE ]; then
            echo "‚ùå Bot dist size ($BOT_SIZE bytes) exceeds 3.5 MB limit"
            exit 1
          fi

          echo "ü§ñ Deploying bot to function: ${YC_BOT_FUNCTION_ID}"
          yc serverless function version create \
            --function-id "${YC_BOT_FUNCTION_ID}" \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --environment NODE_ENV=production \
            --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }}

          echo "‚úÖ Bot deployed successfully"

      - name: Health check
        if: steps.changed-files.outputs.backend == 'true' || steps.changed-files.outputs.shared == 'true' || steps.force-deploy.outputs.force_all == 'true'
        env:
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: |
          echo "üîç Performing health checks..."

          # Check backend health if it was deployed
          if [ -n "${BACKEND_URL}" ] && [ "${BACKEND_URL}" != "null" ]; then
            echo "‚è≥ Checking backend health at ${BACKEND_URL}/health..."
            echo "üîç Backend URL: ${BACKEND_URL}"
            
            # Wait longer for container to start (Yandex Cloud containers can take 30-60 seconds)
            echo "‚è≥ Waiting 30 seconds for container to start..."
            sleep 30
            
            HEALTH_CHECK_PASSED=0
            for i in {1..20}; do
              echo "‚è≥ Attempt $i/20: Checking ${BACKEND_URL}/health..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${BACKEND_URL}/health" || echo "000")
              
              if [ "${HTTP_CODE}" = "200" ]; then
                echo "‚úÖ Backend health check passed! (HTTP ${HTTP_CODE})"
                HEALTH_CHECK_PASSED=1
                break
              else
                echo "‚è≥ Attempt $i/20: Backend returned HTTP ${HTTP_CODE}, waiting..."
                sleep 5
              fi
            done
            
            if [ "${HEALTH_CHECK_PASSED}" -eq 0 ]; then
              echo "‚ùå ERROR: Backend health check failed after 20 attempts"
              echo "Backend may not be responding correctly at ${BACKEND_URL}/health"
              echo "Please check:"
              echo "  1. Container logs in Yandex Cloud Console"
              echo "  2. Container is running and healthy"
              echo "  3. Environment variables are set correctly"
              echo "  4. Database connection is working"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Backend URL not available, skipping backend health check"
          fi

          echo "‚úÖ Production deployment completed successfully"
