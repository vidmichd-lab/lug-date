name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main # Production
      - develop # Staging
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '18.x'
  BACKEND_IMAGE_NAME: dating-app-backend

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build all packages
        run: npm run build:all

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging-api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: NODE_ENV=development npm run build:all

      - name: Configure Yandex Cloud CLI
        uses: yandex-cloud/actions-yc-cli@v1
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}

      - name: Run database migrations
        run: |
          # Export service account key for YDB SDK
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          NODE_ENV=development \
          YDB_ENDPOINT_DEV=${{ secrets.YDB_ENDPOINT_DEV }} \
          YDB_DATABASE_DEV=${{ secrets.YDB_DATABASE_DEV }} \
          npm run migrate || echo "Migrations failed, but continuing deployment"
        continue-on-error: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Yandex Container Registry
        run: |
          # Get IAM token for Docker login
          yc iam create-token | docker login --username iam --password-stdin cr.yandex

      - name: Build and push Docker image
        run: |
          CR_REGISTRY_ID="${{ secrets.CR_REGISTRY_ID }}"
          if [ -z "$CR_REGISTRY_ID" ]; then
            echo "Error: CR_REGISTRY_ID secret is not set"
            exit 1
          fi
          IMAGE_TAG="cr.yandex/${CR_REGISTRY_ID}/${{ env.BACKEND_IMAGE_NAME }}:staging-${GITHUB_SHA::8}"
          IMAGE_LATEST="cr.yandex/${CR_REGISTRY_ID}/${{ env.BACKEND_IMAGE_NAME }}:staging-latest"
          
          # Build Docker image
          docker build \
            -f backend/Dockerfile \
            -t "$IMAGE_TAG" \
            -t "$IMAGE_LATEST" \
            .
          
          # Push to Container Registry
          docker push "$IMAGE_TAG"
          docker push "$IMAGE_LATEST"
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Backend
        run: |
          yc serverless function version create \
            --function-name dating-app-backend-staging \
            --runtime container \
            --entrypoint "handler.handler" \
            --memory 128m \
            --execution-timeout 10s \
            --image "${{ env.IMAGE_TAG }}" \
            --environment NODE_ENV=development,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }},YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }},YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }},YC_SERVICE_ACCOUNT_KEY=${{ secrets.YC_SERVICE_ACCOUNT_KEY }},YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }},YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }},YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }},TELEGRAM_ALERT_ENABLED=true,TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }},TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}

      - name: Deploy Frontend
        run: |
          yc storage s3 cp frontend/dist/ \
            s3://dating-app-frontend-staging/ \
            --recursive

      - name: Deploy Bot
        run: |
          yc serverless function version create \
            --function-name dating-app-bot-staging \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --environment NODE_ENV=development,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }}

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 10
          # Add actual health check URL when available
          echo "Health check completed"

  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: NODE_ENV=production npm run build:all

      - name: Configure Yandex Cloud CLI
        uses: yandex-cloud/actions-yc-cli@v1
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}

      - name: Run database migrations
        run: |
          # Export service account key for YDB SDK
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          NODE_ENV=production \
          YDB_ENDPOINT_PROD=${{ secrets.YDB_ENDPOINT_PROD }} \
          YDB_DATABASE_PROD=${{ secrets.YDB_DATABASE_PROD }} \
          npm run migrate

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Yandex Container Registry
        run: |
          # Get IAM token for Docker login
          yc iam create-token | docker login --username iam --password-stdin cr.yandex

      - name: Build and push Docker image
        run: |
          CR_REGISTRY_ID="${{ secrets.CR_REGISTRY_ID }}"
          if [ -z "$CR_REGISTRY_ID" ]; then
            echo "Error: CR_REGISTRY_ID secret is not set"
            exit 1
          fi
          IMAGE_TAG="cr.yandex/${CR_REGISTRY_ID}/${{ env.BACKEND_IMAGE_NAME }}:prod-${GITHUB_SHA::8}"
          IMAGE_LATEST="cr.yandex/${CR_REGISTRY_ID}/${{ env.BACKEND_IMAGE_NAME }}:prod-latest"
          
          # Build Docker image
          docker build \
            -f backend/Dockerfile \
            -t "$IMAGE_TAG" \
            -t "$IMAGE_LATEST" \
            .
          
          # Push to Container Registry
          docker push "$IMAGE_TAG"
          docker push "$IMAGE_LATEST"
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Backend
        run: |
          yc serverless function version create \
            --function-name dating-app-backend-prod \
            --runtime container \
            --entrypoint "handler.handler" \
            --memory 256m \
            --execution-timeout 30s \
            --image "${{ env.IMAGE_TAG }}" \
            --environment NODE_ENV=production,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }},YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }},YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }},YC_SERVICE_ACCOUNT_KEY=${{ secrets.YC_SERVICE_ACCOUNT_KEY }},YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }},YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }},YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }},TELEGRAM_ALERT_ENABLED=true,TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }},TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}

      - name: Deploy Frontend
        run: |
          yc storage s3 cp frontend/dist/ \
            s3://dating-app-frontend-prod/ \
            --recursive

      - name: Deploy Bot
        run: |
          yc serverless function version create \
            --function-name dating-app-bot-prod \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --environment NODE_ENV=production,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }}

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 15
          # Add actual health check URL when available
          echo "Health check completed"
