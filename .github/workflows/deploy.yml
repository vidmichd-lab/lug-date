name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main # Production
      - develop # Staging
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '18.x'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --max-warnings 999 || true

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Build all packages
        run: npm run build --workspace=frontend --workspace=backend --workspace=bot --workspace=admin

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging-api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Build all packages
        run: NODE_ENV=development npm run build --workspace=frontend --workspace=backend --workspace=bot --workspace=admin

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          yc config set service-account-key /tmp/yc-sa-key.json

      - name: Run database migrations
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          NODE_ENV=development \
          YDB_ENDPOINT_DEV=${{ secrets.YDB_ENDPOINT_DEV }} \
          YDB_DATABASE_DEV=${{ secrets.YDB_DATABASE_DEV }} \
          npm run migrate || echo "‚ö†Ô∏è Migrations skipped"
        continue-on-error: true

      - name: Build and push Docker image
        env:
          REGISTRY: cr.yandex
          REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          # Verify registry ID is set
          if [ -z "$REGISTRY_ID" ]; then
            echo "‚ùå REGISTRY_ID is empty!"
            exit 1
          fi
          
          echo "üì¶ Building image..."
          IMAGE_TAG="${REGISTRY}/${REGISTRY_ID}/dating-app-backend:${GITHUB_SHA:0:7}"
          docker build -f backend/Dockerfile -t $IMAGE_TAG .
          
          echo ""
          echo "üîê Configuring Docker authentication..."
          yc container registry configure-docker --folder-id $(yc config get folder-id)
          
          echo ""
          echo "üîç Verifying registry access..."
          yc container registry list || echo "‚ö†Ô∏è Could not list registries"
          
          echo ""
          echo "üì§ Pushing image to $IMAGE_TAG..."
          if docker push $IMAGE_TAG; then
            echo "‚úÖ Push successful!"
            echo "IMAGE_URL=$IMAGE_TAG" >> $GITHUB_ENV
          else
            echo "‚ùå Push failed. Checking permissions..."
            echo "Registry ID: $REGISTRY_ID"
            yc container registry list
            exit 1
          fi

      - name: Deploy Backend
        env:
          YC_FUNCTION_ID: ${{ secrets.YC_BACKEND_FUNCTION_ID_STAGING }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          yc serverless function version create \
            --function-id "${YC_FUNCTION_ID}" \
            --runtime container \
            --memory 128m \
            --execution-timeout 30s \
            --image "${{ env.IMAGE_URL }}" \
            --set-env-variable NODE_ENV=development \
            --set-env-variable PORT=8080 \
            --set-env-variable TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }} \
            --set-env-variable YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }} \
            --set-env-variable YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }} \
            --set-env-variable YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
            --set-env-variable YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }} \
            --set-env-variable YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }} \
            --set-env-variable YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }} \
            --set-env-variable TELEGRAM_ALERT_ENABLED=true \
            --set-env-variable TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
            --set-env-variable TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}

      - name: Deploy Frontend
        env:
          YANDEX_STORAGE_BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_DEV }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          yc storage s3 cp \
            frontend/dist/ \
            s3://${YANDEX_STORAGE_BUCKET}/ \
            --recursive

      - name: Deploy Bot
        env:
          YC_BOT_FUNCTION_ID: ${{ secrets.YC_BOT_FUNCTION_ID_STAGING }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          # Check bot/dist size
          BOT_SIZE=$(du -sb bot/dist | cut -f1)
          MAX_SIZE=$((3500000))
          
          if [ $BOT_SIZE -gt $MAX_SIZE ]; then
            echo "‚ùå Bot dist size ($BOT_SIZE bytes) exceeds 3.5 MB limit"
            exit 1
          fi
          
          yc serverless function version create \
            --function-id "${YC_BOT_FUNCTION_ID}" \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --set-env-variable NODE_ENV=development \
            --set-env-variable TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }}

      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 10
          echo "‚úÖ Staging deployment completed"

  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package first
        run: npm run build --workspace=shared

      - name: Build all packages
        run: NODE_ENV=production npm run build --workspace=frontend --workspace=backend --workspace=bot --workspace=admin

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          yc config set service-account-key /tmp/yc-sa-key.json

      - name: Run database migrations
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          NODE_ENV=production \
          YDB_ENDPOINT_PROD=${{ secrets.YDB_ENDPOINT_PROD }} \
          YDB_DATABASE_PROD=${{ secrets.YDB_DATABASE_PROD }} \
          npm run migrate
        continue-on-error: true

      - name: Build and push Docker image
        env:
          REGISTRY: cr.yandex
          REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          # Verify registry ID is set
          if [ -z "$REGISTRY_ID" ]; then
            echo "‚ùå REGISTRY_ID is empty!"
            exit 1
          fi
          
          echo "üì¶ Building image..."
          IMAGE_TAG="${REGISTRY}/${REGISTRY_ID}/dating-app-backend:${GITHUB_SHA:0:7}"
          docker build -f backend/Dockerfile -t $IMAGE_TAG .
          
          echo ""
          echo "üîê Configuring Docker authentication..."
          yc container registry configure-docker --folder-id $(yc config get folder-id)
          
          echo ""
          echo "üîç Verifying registry access..."
          yc container registry list || echo "‚ö†Ô∏è Could not list registries"
          
          echo ""
          echo "üì§ Pushing image to $IMAGE_TAG..."
          if docker push $IMAGE_TAG; then
            echo "‚úÖ Push successful!"
            echo "IMAGE_URL=$IMAGE_TAG" >> $GITHUB_ENV
          else
            echo "‚ùå Push failed. Checking permissions..."
            echo "Registry ID: $REGISTRY_ID"
            yc container registry list
            exit 1
          fi

      - name: Deploy Backend
        env:
          YC_FUNCTION_ID: ${{ secrets.YC_BACKEND_FUNCTION_ID_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          yc serverless function version create \
            --function-id "${YC_FUNCTION_ID}" \
            --runtime container \
            --memory 256m \
            --execution-timeout 30s \
            --image "${{ env.IMAGE_URL }}" \
            --set-env-variable NODE_ENV=production \
            --set-env-variable PORT=8080 \
            --set-env-variable TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }} \
            --set-env-variable YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }} \
            --set-env-variable YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }} \
            --set-env-variable YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
            --set-env-variable YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }} \
            --set-env-variable YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }} \
            --set-env-variable YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }} \
            --set-env-variable TELEGRAM_ALERT_ENABLED=true \
            --set-env-variable TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
            --set-env-variable TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}

      - name: Deploy Frontend
        env:
          YANDEX_STORAGE_BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          yc storage s3 cp \
            frontend/dist/ \
            s3://${YANDEX_STORAGE_BUCKET}/ \
            --recursive

      - name: Deploy Bot
        env:
          YC_BOT_FUNCTION_ID: ${{ secrets.YC_BOT_FUNCTION_ID_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          
          # Check bot/dist size
          BOT_SIZE=$(du -sb bot/dist | cut -f1)
          MAX_SIZE=$((3500000))
          
          if [ $BOT_SIZE -gt $MAX_SIZE ]; then
            echo "‚ùå Bot dist size ($BOT_SIZE bytes) exceeds 3.5 MB limit"
            exit 1
          fi
          
          yc serverless function version create \
            --function-id "${YC_BOT_FUNCTION_ID}" \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path bot/dist \
            --set-env-variable NODE_ENV=production \
            --set-env-variable TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }}

      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 15
          echo "‚úÖ Production deployment completed"
