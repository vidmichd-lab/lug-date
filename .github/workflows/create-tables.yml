name: Create YDB Tables

on:
  workflow_dispatch: # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [main]
    paths:
      - '.github/workflows/create-tables.yml'

env:
  NODE_VERSION: '20'

jobs:
  create-tables:
    name: Create migrations tables in YDB
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Create migrations table
        timeout-minutes: 5
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YDB_ENDPOINT: ${{ secrets.YDB_ENDPOINT }}
          YDB_DATABASE: ${{ secrets.YDB_DATABASE }}
        run: |
          cd backend

          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å Service Account –∫–ª—é—á–æ–º
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/yc-sa-key.json"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          if [ -z "$YDB_ENDPOINT" ] || [ -z "$YDB_DATABASE" ]; then
            echo "‚ùå ERROR: YDB_ENDPOINT or YDB_DATABASE is not set"
            exit 1
          fi

          echo "üîå Connecting to YDB..."
          echo "Endpoint: $YDB_ENDPOINT"
          echo "Database: $YDB_DATABASE"

          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
          npm run create:tables || {
            echo "‚ö†Ô∏è  Script failed, but this might be OK if tables already exist"
            echo "Checking if we can query the tables..."
            
            # –ü–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
            npm run migrate:status || echo "‚ö†Ô∏è  Cannot check migration status"
          }

      - name: Verify tables created
        timeout-minutes: 3
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YDB_ENDPOINT: ${{ secrets.YDB_ENDPOINT }}
          YDB_DATABASE: ${{ secrets.YDB_DATABASE }}
        run: |
          cd backend

          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å Service Account –∫–ª—é—á–æ–º
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/yc-sa-key.json"

          echo "‚úÖ Verifying tables were created..."
          npm run migrate:status || {
            echo "‚ö†Ô∏è  Warning: Could not verify tables, but they might still exist"
            echo "If this is the first run, tables should be created now"
          }
