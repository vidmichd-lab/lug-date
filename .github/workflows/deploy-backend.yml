name: Deploy Backend

on:
  push:
    branches: [develop, main]
    paths:
      - 'backend/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --workspace=backend
        continue-on-error: true # –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º warnings

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º JSON –∫–ª—é—á –≤ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          # cloud-id –∏ folder-id –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
          if [ -n "$YC_CLOUD_ID" ]; then
            yc config set cloud-id "$YC_CLOUD_ID" || true
          fi
          if [ -n "$YC_FOLDER_ID" ]; then
            yc config set folder-id "$YC_FOLDER_ID" || true
          fi

      - name: Login to Yandex Container Registry
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # –ü—É—à–∏–º –æ–±—Ä–∞–∑
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–µ–ø–ª–æ—è
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
          docker images ${IMAGE_NAME}:${IMAGE_TAG}

      - name: Create container if not exists
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
          if [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container create \
              --name=lug-date-backend-staging \
              --folder-id="${YC_FOLDER_ID}" || echo "Container already exists"
          else
            yc serverless container create --name=lug-date-backend-staging || echo "Container already exists"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service account, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω
          if [ $? -eq 0 ] && [ -n "${YC_SERVICE_ACCOUNT_ID}" ]; then
            if [ -n "${YC_FOLDER_ID}" ]; then
              yc serverless container set-access-bindings \
                --name=lug-date-backend-staging \
                --folder-id="${YC_FOLDER_ID}" \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            else
              yc serverless container set-access-bindings \
                --name=lug-date-backend-staging \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            fi
          fi

      - name: Deploy to Yandex Cloud Container
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_STAGING: ${{ secrets.YC_CONTAINER_ID_STAGING }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º container-id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏–Ω–∞—á–µ container-name —Å folder-id
          if [ -n "${YC_CONTAINER_ID_STAGING}" ]; then
            yc serverless container revision deploy \
              --container-id="${YC_CONTAINER_ID_STAGING}" \
              --image=${{ env.IMAGE_ID }} \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=development \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
          elif [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container revision deploy \
              --container-name=lug-date-backend-staging \
              --folder-id="${YC_FOLDER_ID}" \
              --image=${{ env.IMAGE_ID }} \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=development \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
          else
            echo "Error: Either YC_CONTAINER_ID_STAGING or YC_FOLDER_ID must be set"
            exit 1
          fi

      - name: Get Container URL
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_STAGING: ${{ secrets.YC_CONTAINER_ID_STAGING }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -n "${YC_CONTAINER_ID_STAGING}" ]; then
            CONTAINER_URL=$(yc serverless container get --id="${YC_CONTAINER_ID_STAGING}" --format json | jq -r '.url')
          elif [ -n "${YC_FOLDER_ID}" ]; then
            CONTAINER_URL=$(yc serverless container get --name=lug-date-backend-staging --folder-id="${YC_FOLDER_ID}" --format json | jq -r '.url')
          else
            echo "‚ùå ERROR: Cannot get container URL - neither YC_CONTAINER_ID_STAGING nor YC_FOLDER_ID is set"
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_STAGING or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

          if [ -n "${CONTAINER_URL}" ] && [ "${CONTAINER_URL}" != "null" ]; then
            echo "‚úÖ Container deployed: ${CONTAINER_URL}"
            echo "üîç Health check: ${CONTAINER_URL}/health"
          else
            echo "‚ùå ERROR: Container URL is empty or null"
            echo "Please check:"
            echo "  1. Backend container exists in Yandex Cloud"
            echo "  2. Container has been deployed successfully"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

      - name: Health check
        run: |
          echo "Waiting for function to start..."
          sleep 10
          echo "Deployment completed"

  deploy-production:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --workspace=backend
        continue-on-error: true # –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º warnings

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º JSON –∫–ª—é—á –≤ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          # cloud-id –∏ folder-id –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
          if [ -n "$YC_CLOUD_ID" ]; then
            yc config set cloud-id "$YC_CLOUD_ID" || true
          fi
          if [ -n "$YC_FOLDER_ID" ]; then
            yc config set folder-id "$YC_FOLDER_ID" || true
          fi

      - name: Login to Yandex Container Registry
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # –ü—É—à–∏–º –æ–±—Ä–∞–∑
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–µ–ø–ª–æ—è
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
          docker images ${IMAGE_NAME}:${IMAGE_TAG}

      - name: Create container if not exists
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
          if [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container create \
              --name=lug-date-backend-prod \
              --folder-id="${YC_FOLDER_ID}" || echo "Container already exists"
          else
            yc serverless container create --name=lug-date-backend-prod || echo "Container already exists"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service account, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω
          if [ $? -eq 0 ] && [ -n "${YC_SERVICE_ACCOUNT_ID}" ]; then
            if [ -n "${YC_FOLDER_ID}" ]; then
              yc serverless container set-access-bindings \
                --name=lug-date-backend-prod \
                --folder-id="${YC_FOLDER_ID}" \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            else
              yc serverless container set-access-bindings \
                --name=lug-date-backend-prod \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            fi
          fi

      - name: Deploy to Yandex Cloud Container
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_PROD: ${{ secrets.YC_CONTAINER_ID_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º container-id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏–Ω–∞—á–µ container-name —Å folder-id
          if [ -n "${YC_CONTAINER_ID_PROD}" ]; then
            yc serverless container revision deploy \
              --container-id="${YC_CONTAINER_ID_PROD}" \
              --image=${{ env.IMAGE_ID }} \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
          elif [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container revision deploy \
              --container-name=lug-date-backend-prod \
              --folder-id="${YC_FOLDER_ID}" \
              --image=${{ env.IMAGE_ID }} \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }} \
              --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
          else
            echo "Error: Either YC_CONTAINER_ID_PROD or YC_FOLDER_ID must be set"
            exit 1
          fi

      - name: Get Container URL
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID_PROD: ${{ secrets.YC_CONTAINER_ID_PROD }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          if [ -n "${YC_CONTAINER_ID_PROD}" ]; then
            CONTAINER_URL=$(yc serverless container get --id="${YC_CONTAINER_ID_PROD}" --format json | jq -r '.url')
          elif [ -n "${YC_FOLDER_ID}" ]; then
            CONTAINER_URL=$(yc serverless container get --name=lug-date-backend-prod --folder-id="${YC_FOLDER_ID}" --format json | jq -r '.url')
          else
            echo "‚ùå ERROR: Cannot get container URL - neither YC_CONTAINER_ID_PROD nor YC_FOLDER_ID is set"
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID_PROD or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

          if [ -n "${CONTAINER_URL}" ] && [ "${CONTAINER_URL}" != "null" ]; then
            echo "‚úÖ Container deployed: ${CONTAINER_URL}"
            echo "üîç Health check: ${CONTAINER_URL}/health"
          else
            echo "‚ùå ERROR: Container URL is empty or null"
            echo "Please check:"
            echo "  1. Backend container exists in Yandex Cloud"
            echo "  2. Container has been deployed successfully"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

      - name: Health check
        run: |
          echo "Waiting for function to start..."
          sleep 15
          echo "Deployment completed"
