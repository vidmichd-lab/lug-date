name: Deploy Backend

on:
  push:
    branches: [develop, main]
    paths:
      - 'backend/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy-production:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --workspace=backend

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq || echo "jq may already be installed"

      - name: Configure Yandex Cloud CLI
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º JSON –∫–ª—é—á –≤ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
          echo "$YC_SERVICE_ACCOUNT_KEY" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          # cloud-id –∏ folder-id –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
          if [ -n "$YC_CLOUD_ID" ]; then
            yc config set cloud-id "$YC_CLOUD_ID" || true
          fi
          if [ -n "$YC_FOLDER_ID" ]; then
            yc config set folder-id "$YC_FOLDER_ID" || true
          fi

      - name: Login to Yandex Container Registry
        timeout-minutes: 5
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          if [ -z "$YC_SERVICE_ACCOUNT_KEY" ]; then
            echo "‚ùå ERROR: YC_SERVICE_ACCOUNT_KEY is not set"
            exit 1
          fi

          echo "üîê Authenticating with Yandex Container Registry..."
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: Docker login failed"
            exit 1
          fi

          echo "‚úÖ Successfully authenticated with Container Registry"

      - name: Test registry connectivity
        timeout-minutes: 5
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          if [ -z "$YC_REGISTRY_ID" ]; then
            echo "‚ö†Ô∏è  WARNING: YC_REGISTRY_ID is not set, skipping connectivity test"
            exit 0
          fi

          echo "üîç Testing registry connectivity..."
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

          # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          docker pull "cr.yandex/${YC_REGISTRY_ID}/lug-date-backend:latest" || echo "‚ÑπÔ∏è  No previous image found (this is OK for first deployment)"

          echo "‚úÖ Registry connectivity test passed"

      - name: Set image metadata
        id: image-metadata
        env:
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
        run: |
          if [ -z "$YC_REGISTRY_ID" ]; then
            echo "‚ùå ERROR: YC_REGISTRY_ID is not set"
            exit 1
          fi

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${YC_REGISTRY_ID}/lug-date-backend"

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

          echo "üì¶ Image will be built as: ${IMAGE_NAME}:${IMAGE_TAG}"

      - name: Login to Container Registry for build-push-action
        timeout-minutes: 5
        uses: docker/login-action@v3
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}

      - name: Build and push Docker image
        timeout-minutes: 45
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max
          platforms: linux/amd64
          # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
          no-cache: false
          pull: true

      - name: Check image size
        timeout-minutes: 5
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

          echo "üìä Checking image size..."
          docker images "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

          # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞
          IMAGE_SIZE=$(docker images "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" --format "{{.Size}}")
          echo "Image size: ${IMAGE_SIZE}"

          # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –±–µ–∑ bc (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–æ—Ä–º–∞—Ç–æ–º —Ç–∏–ø–∞ "123MB" –∏–ª–∏ "1.2GB")
          if echo "$IMAGE_SIZE" | grep -qE '[0-9]+(\.[0-9]+)?GB'; then
            echo "‚ö†Ô∏è  WARNING: Image size is ${IMAGE_SIZE}, which is larger than recommended 500MB"
            echo "Consider optimizing the Dockerfile or using .dockerignore to exclude unnecessary files"
          elif echo "$IMAGE_SIZE" | grep -qE '[5-9][0-9]{2,}MB|[0-9]{4,}MB'; then
            SIZE_NUM=$(echo "$IMAGE_SIZE" | grep -oE '[0-9]+' | head -1)
            if [ -n "$SIZE_NUM" ] && [ "$SIZE_NUM" -gt 500 ]; then
              echo "‚ö†Ô∏è  WARNING: Image size is ${IMAGE_SIZE}, which is larger than recommended 500MB"
              echo "Consider optimizing the Dockerfile or using .dockerignore to exclude unnecessary files"
            else
              echo "‚úÖ Image size is acceptable: ${IMAGE_SIZE}"
            fi
          else
            echo "‚úÖ Image size is acceptable: ${IMAGE_SIZE}"
          fi

      - name: Create container if not exists
        timeout-minutes: 10
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
          CONTAINER_CREATED=0
          if [ -n "${YC_FOLDER_ID}" ]; then
            yc serverless container create \
              --name=lug-date-backend \
              --folder-id="${YC_FOLDER_ID}" && CONTAINER_CREATED=1 || echo "Container already exists"
          else
            yc serverless container create --name=lug-date-backend && CONTAINER_CREATED=1 || echo "Container already exists"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º service account, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω
          if [ "${CONTAINER_CREATED}" -eq 1 ] && [ -n "${YC_SERVICE_ACCOUNT_ID}" ]; then
            if [ -n "${YC_FOLDER_ID}" ]; then
              yc serverless container set-access-bindings \
                --name=lug-date-backend \
                --folder-id="${YC_FOLDER_ID}" \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            else
              yc serverless container set-access-bindings \
                --name=lug-date-backend \
                --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
                --role=serverless.containers.invoker || true
            fi
          fi

      - name: Deploy to Yandex Cloud Container
        timeout-minutes: 15
        env:
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID: ${{ secrets.YC_CONTAINER_ID }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Set default values for admin credentials using bash parameter expansion
          ADMIN_USERNAME_VAL="${ADMIN_USERNAME:-admin}"
          ADMIN_PASSWORD_VAL="${ADMIN_PASSWORD:-admin123}"
          ADMIN_TOKEN_VAL="${ADMIN_TOKEN:-admin-secret-token-change-in-production}"

          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è retry —Å –ø—Ä–æ—Å—Ç—ã–º –ø–æ–¥—Ö–æ–¥–æ–º
          deploy_with_retry() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "üîÑ Deployment attempt $attempt of $max_attempts..."
              
              if [ $attempt -eq $max_attempts ]; then
                # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –≤—ã–ø–æ–ª–Ω—è–µ–º –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
                "$@" && return 0 || return 1
              else
                # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
                if "$@"; then
                  echo "‚úÖ Deployment succeeded on attempt $attempt"
                  return 0
                else
                  echo "‚ö†Ô∏è  Attempt $attempt failed, waiting 10 seconds before retry..."
                  sleep 10
                  attempt=$((attempt + 1))
                fi
              fi
            done
            
            echo "‚ùå All $max_attempts attempts failed"
            return 1
          }

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º container-id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏–Ω–∞—á–µ container-name —Å folder-id
          if [ -n "${YC_CONTAINER_ID}" ]; then
            deploy_with_retry yc serverless container revision deploy \
              --container-id="${YC_CONTAINER_ID}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment CONTAINER_MODE=true \
              --environment PORT=8080 \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE }} \
              --environment YC_SERVICE_ACCOUNT_KEY="${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME_VAL}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD_VAL}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN_VAL}"
          elif [ -n "${YC_FOLDER_ID}" ]; then
            deploy_with_retry yc serverless container revision deploy \
              --container-name=lug-date-backend \
              --folder-id="${YC_FOLDER_ID}" \
              --image="${{ env.IMAGE_ID }}" \
              --memory=512m \
              --cores=1 \
              --execution-timeout=30s \
              --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
              --environment NODE_ENV=production \
              --environment CONTAINER_MODE=true \
              --environment PORT=8080 \
              --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT }} \
              --environment YDB_DATABASE=${{ secrets.YDB_DATABASE }} \
              --environment YC_SERVICE_ACCOUNT_KEY="${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" \
              --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET }} \
              --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY }} \
              --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY }} \
              --environment TELEGRAM_ALERT_ENABLED=true \
              --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
              --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }} \
              --environment ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }} \
              --environment ADMIN_ORIGINS=${{ secrets.ADMIN_ORIGINS }} \
              --environment ADMIN_USERNAME="${ADMIN_USERNAME_VAL}" \
              --environment ADMIN_PASSWORD="${ADMIN_PASSWORD_VAL}" \
              --environment ADMIN_TOKEN="${ADMIN_TOKEN_VAL}"
          else
            echo "Error: Either YC_CONTAINER_ID or YC_FOLDER_ID must be set"
            exit 1
          fi

      - name: Get Container URL
        timeout-minutes: 10
        env:
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CONTAINER_ID: ${{ secrets.YC_CONTAINER_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          echo "üîç Getting backend URL..."
          echo "YC_CONTAINER_ID: ${YC_CONTAINER_ID:0:20}..."
          echo "YC_FOLDER_ID: ${YC_FOLDER_ID}"

          # Try to get CONTAINER_URL
          CONTAINER_URL=""
          CONTAINER_JSON=""

          if [ -n "${YC_CONTAINER_ID}" ]; then
            echo "üîç Fetching container info using container ID..."
            CONTAINER_JSON=$(yc serverless container get --id="${YC_CONTAINER_ID}" --format json 2>&1)
            YC_EXIT_CODE=$?
            
            if [ $YC_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERROR: yc command failed with exit code $YC_EXIT_CODE"
              echo "Output: ${CONTAINER_JSON}"
              echo "Please check:"
              echo "  1. Backend container exists in Yandex Cloud"
              echo "  2. Service account has permissions to read container info"
              echo "  3. YC_CONTAINER_ID is correct"
              exit 1
            fi

            echo "üìÑ Container JSON response:"
            echo "${CONTAINER_JSON}" | jq '.' || echo "${CONTAINER_JSON}"
            
            CONTAINER_URL=$(echo "${CONTAINER_JSON}" | jq -r '.url // empty' 2>/dev/null)
            
            if [ -z "${CONTAINER_URL}" ] || [ "${CONTAINER_URL}" == "null" ]; then
              echo "‚ö†Ô∏è  WARNING: Container exists but URL field is empty or null"
              echo "This might mean the container hasn't been deployed yet or has no active revision"
              echo "Trying to get URL from status or other fields..."
              
              # Try to get URL from other fields
              CONTAINER_URL=$(echo "${CONTAINER_JSON}" | jq -r '.status.url // .current_revision.url // .url // empty' 2>/dev/null)
              
              if [ -z "${CONTAINER_URL}" ] || [ "${CONTAINER_URL}" == "null" ]; then
                echo "‚ùå ERROR: Cannot extract container URL from container info"
                echo "Container JSON was:"
                echo "${CONTAINER_JSON}"
                echo ""
                echo "Please check:"
                echo "  1. Container has been deployed successfully (has active revision)"
                echo "  2. Container revision is in 'ACTIVE' status"
                exit 1
              fi
            fi
            
            echo "‚úÖ Got backend URL from container ID: ${CONTAINER_URL}"
            
          elif [ -n "${YC_FOLDER_ID}" ]; then
            echo "üîç Fetching container info using folder ID and name..."
            CONTAINER_JSON=$(yc serverless container get --name=lug-date-backend --folder-id="${YC_FOLDER_ID}" --format json 2>&1)
            YC_EXIT_CODE=$?
            
            if [ $YC_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERROR: yc command failed with exit code $YC_EXIT_CODE"
              echo "Output: ${CONTAINER_JSON}"
              echo "Please check:"
              echo "  1. Backend container exists in Yandex Cloud"
              echo "  2. Service account has permissions to read container info"
              echo "  3. Container name 'lug-date-backend' is correct"
              exit 1
            fi

            echo "üìÑ Container JSON response:"
            echo "${CONTAINER_JSON}" | jq '.' || echo "${CONTAINER_JSON}"
            
            CONTAINER_URL=$(echo "${CONTAINER_JSON}" | jq -r '.url // empty' 2>/dev/null)
            
            if [ -z "${CONTAINER_URL}" ] || [ "${CONTAINER_URL}" == "null" ]; then
              echo "‚ö†Ô∏è  WARNING: Container exists but URL field is empty or null"
              echo "This might mean the container hasn't been deployed yet or has no active revision"
              echo "Trying to get URL from status or other fields..."
              
              # Try to get URL from other fields
              CONTAINER_URL=$(echo "${CONTAINER_JSON}" | jq -r '.status.url // .current_revision.url // .url // empty' 2>/dev/null)
              
              if [ -z "${CONTAINER_URL}" ] || [ "${CONTAINER_URL}" == "null" ]; then
                echo "‚ùå ERROR: Cannot extract container URL from container info"
                echo "Container JSON was:"
                echo "${CONTAINER_JSON}"
                echo ""
                echo "Please check:"
                echo "  1. Container has been deployed successfully (has active revision)"
                echo "  2. Container revision is in 'ACTIVE' status"
                exit 1
              fi
            fi
            
            echo "‚úÖ Got backend URL from folder ID: ${CONTAINER_URL}"
            
          else
            echo "‚ùå ERROR: Cannot get container URL - neither YC_CONTAINER_ID nor YC_FOLDER_ID is set"
            echo "Please check:"
            echo "  1. YC_CONTAINER_ID or YC_FOLDER_ID is set in GitHub Secrets"
            echo "  2. Backend container exists in Yandex Cloud"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

          # Validate CONTAINER_URL
          if [ -n "${CONTAINER_URL}" ] && [ "${CONTAINER_URL}" != "null" ]; then
            echo "‚úÖ Container deployed: ${CONTAINER_URL}"
            echo "üîç Health check: ${CONTAINER_URL}/health"
          else
            echo "‚ùå ERROR: Container URL is empty or null after extraction"
            echo "Container JSON was:"
            echo "${CONTAINER_JSON}"
            echo ""
            echo "Please check:"
            echo "  1. Backend container exists in Yandex Cloud"
            echo "  2. Container has been deployed successfully (has active revision)"
            echo "  3. Service account has permissions to read container info"
            exit 1
          fi

      - name: Health check
        run: |
          echo "Waiting for function to start..."
          sleep 15
          echo "Deployment completed"
