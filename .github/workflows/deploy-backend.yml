name: Deploy Backend

on:
  push:
    branches: [develop, main]
    paths:
      - 'backend/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --workspace=backend
        continue-on-error: true # Временно пропускаем warnings

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          echo "${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }} || true
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }} || true

      - name: Login to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # Собираем образ
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # Пушим образ
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # Сохраняем для деплоя
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

          # Показываем размер
          docker images ${IMAGE_NAME}:${IMAGE_TAG}

      - name: Deploy to Yandex Cloud Function
        env:
          YC_FUNCTION_ID: ${{ secrets.YC_BACKEND_FUNCTION_ID_STAGING }}
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          yc serverless function version create \
            --function-id="${YC_FUNCTION_ID}" \
            --runtime=custom-image \
            --image=${{ env.IMAGE_ID }} \
            --memory=512m \
            --execution-timeout=30s \
            --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
            --environment NODE_ENV=development \
            --environment PORT=8080 \
            --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_DEV }} \
            --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_DEV }} \
            --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_DEV }} \
            --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
            --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_DEV }} \
            --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }} \
            --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_DEV }} \
            --environment TELEGRAM_ALERT_ENABLED=true \
            --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
            --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}

      - name: Get Function URL
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          FUNCTION_ID=$(yc serverless function get --id ${{ secrets.YC_BACKEND_FUNCTION_ID_STAGING }} --format json | jq -r '.id')
          echo "Function deployed: https://functions.yandexcloud.net/${FUNCTION_ID}"

      - name: Health check
        run: |
          echo "Waiting for function to start..."
          sleep 10
          echo "Deployment completed"

  deploy-production:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --workspace=backend
        continue-on-error: true # Временно пропускаем warnings

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          echo "${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" > /tmp/yc-sa-key.json
          yc config profile create sa-profile || true
          yc config set service-account-key /tmp/yc-sa-key.json
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }} || true
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }} || true

      - name: Login to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_SERVICE_ACCOUNT_KEY }}" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex

      - name: Build and push Docker image
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_NAME="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/lug-date-backend"

          # Собираем образ
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -t ${IMAGE_NAME}:latest \
            -f backend/Dockerfile \
            .

          # Пушим образ
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

          # Сохраняем для деплоя
          echo "IMAGE_ID=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV

          # Показываем размер
          docker images ${IMAGE_NAME}:${IMAGE_TAG}

      - name: Deploy to Yandex Cloud Function
        env:
          YC_FUNCTION_ID: ${{ secrets.YC_BACKEND_FUNCTION_ID_PROD }}
          YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          yc serverless function version create \
            --function-id="${YC_FUNCTION_ID}" \
            --runtime=custom-image \
            --image=${{ env.IMAGE_ID }} \
            --memory=512m \
            --execution-timeout=30s \
            --service-account-id="${YC_SERVICE_ACCOUNT_ID}" \
            --environment NODE_ENV=production \
            --environment PORT=8080 \
            --environment TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN_PROD }} \
            --environment YDB_ENDPOINT=${{ secrets.YDB_ENDPOINT_PROD }} \
            --environment YDB_DATABASE=${{ secrets.YDB_DATABASE_PROD }} \
            --environment YC_SERVICE_ACCOUNT_KEY='${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' \
            --environment YANDEX_STORAGE_BUCKET=${{ secrets.YANDEX_STORAGE_BUCKET_PROD }} \
            --environment YANDEX_STORAGE_ACCESS_KEY=${{ secrets.YANDEX_STORAGE_ACCESS_KEY_PROD }} \
            --environment YANDEX_STORAGE_SECRET_KEY=${{ secrets.YANDEX_STORAGE_SECRET_KEY_PROD }} \
            --environment TELEGRAM_ALERT_ENABLED=true \
            --environment TELEGRAM_ALERT_BOT_TOKEN=${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }} \
            --environment TELEGRAM_ALERT_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}

      - name: Get Function URL
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          FUNCTION_ID=$(yc serverless function get --id ${{ secrets.YC_BACKEND_FUNCTION_ID_PROD }} --format json | jq -r '.id')
          echo "Function deployed: https://functions.yandexcloud.net/${FUNCTION_ID}"

      - name: Health check
        run: |
          echo "Waiting for function to start..."
          sleep 15
          echo "Deployment completed"
