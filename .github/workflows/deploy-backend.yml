name: Deploy Backend to Yandex Cloud Functions

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=shared

      - name: Build backend
        run: npm run build --workspace=backend

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          export YC_SERVICE_ACCOUNT_KEY_FILE=/tmp/yc-sa-key.json
          yc config set service-account-key /tmp/yc-sa-key.json
          yc config set folder-id ${{ secrets.YC_FOLDER_ID || 'b1g6rst3sps7hhu8tqla' }}

      - name: Run database migrations
        env:
          YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          export NODE_ENV=${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
          export YDB_ENDPOINT=${{ github.ref == 'refs/heads/main' && secrets.YDB_ENDPOINT_PROD || secrets.YDB_ENDPOINT_DEV }}
          export YDB_DATABASE=${{ github.ref == 'refs/heads/main' && secrets.YDB_DATABASE_PROD || secrets.YDB_DATABASE_DEV }}
          export YDB_TOKEN=${{ github.ref == 'refs/heads/main' && secrets.YDB_TOKEN_PROD || secrets.YDB_TOKEN_DEV }}
          npm run migrate --workspace=backend || echo "Migrations failed, but continuing deployment"
        continue-on-error: true

      - name: Create deployment package
        run: |
          cd backend
          mkdir -p deploy-package
          cp -r dist/* deploy-package/
          cp -r ../shared/dist deploy-package/shared-dist
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cd deploy-package
          # Update shared package reference to local path
          sed -i.bak 's/"@dating-app\/shared": "\*"/"@dating-app\/shared": "file:.\/shared-dist"/' package.json
          rm -f package.json.bak
          npm install --production --ignore-scripts
          cd ..
          # Create zip with files in root (not in deploy-package/ folder)
          cd deploy-package
          zip -r ../function.zip . -x "*.git*" "*.DS_Store"
          cd ..
          # Check archive size
          ls -lh function.zip

      - name: Upload archive to Object Storage
        env:
          YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
          YANDEX_STORAGE_BUCKET: ${{ github.ref == 'refs/heads/main' && secrets.YANDEX_STORAGE_BUCKET_PROD || secrets.YANDEX_STORAGE_BUCKET_DEV }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          # Generate unique filename with timestamp and commit SHA
          ARCHIVE_NAME="function-${GITHUB_SHA:0:7}-$(date +%s).zip"
          # Upload to Object Storage using S3 interface (yc storage s3)
          echo "üì¶ Uploading archive to Object Storage bucket: ${YANDEX_STORAGE_BUCKET}/${ARCHIVE_NAME}..."
          yc storage s3 cp \
            backend/function.zip \
            s3://${YANDEX_STORAGE_BUCKET}/${ARCHIVE_NAME}

          # Check if upload was successful
          if [ $? -ne 0 ]; then
            echo "‚ùå Error: Failed to upload archive to Object Storage"
            exit 1
          fi

          # Use https:// format for Yandex Cloud Functions
          FUNCTION_ARCHIVE_URL="https://storage.yandexcloud.net/${YANDEX_STORAGE_BUCKET}/${ARCHIVE_NAME}"
          echo "FUNCTION_ARCHIVE_URL=${FUNCTION_ARCHIVE_URL}" >> $GITHUB_ENV
          echo "‚úÖ Archive uploaded to Object Storage: ${FUNCTION_ARCHIVE_URL}"

          # Verify file is accessible (mandatory check)
          echo "üîç Verifying file accessibility..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FUNCTION_ARCHIVE_URL" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ File is accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Error: File returned HTTP $HTTP_CODE - archive is not accessible"
            exit 1
          fi

      - name: Deploy to Yandex Cloud Functions
        env:
          YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
          YANDEX_STORAGE_BUCKET: ${{ github.ref == 'refs/heads/main' && secrets.YANDEX_STORAGE_BUCKET_PROD || secrets.YANDEX_STORAGE_BUCKET_DEV }}
          # Pass secrets through env section for safe handling
          YDB_ENDPOINT_VAL: ${{ github.ref == 'refs/heads/main' && secrets.YDB_ENDPOINT_PROD || secrets.YDB_ENDPOINT_DEV }}
          YDB_DATABASE_VAL: ${{ github.ref == 'refs/heads/main' && secrets.YDB_DATABASE_PROD || secrets.YDB_DATABASE_DEV }}
          YDB_TOKEN_VAL: ${{ github.ref == 'refs/heads/main' && secrets.YDB_TOKEN_PROD || secrets.YDB_TOKEN_DEV }}
          YC_SA_KEY_VAL: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
          TELEGRAM_BOT_TOKEN_VAL: ${{ github.ref == 'refs/heads/main' && secrets.TELEGRAM_BOT_TOKEN_PROD || secrets.TELEGRAM_BOT_TOKEN_DEV }}
          YANDEX_STORAGE_BUCKET_VAL: ${{ github.ref == 'refs/heads/main' && secrets.YANDEX_STORAGE_BUCKET_PROD || secrets.YANDEX_STORAGE_BUCKET_DEV }}
          YANDEX_STORAGE_ACCESS_KEY_VAL: ${{ github.ref == 'refs/heads/main' && secrets.YANDEX_STORAGE_ACCESS_KEY_PROD || secrets.YANDEX_STORAGE_ACCESS_KEY_DEV }}
          YANDEX_STORAGE_SECRET_KEY_VAL: ${{ github.ref == 'refs/heads/main' && secrets.YANDEX_STORAGE_SECRET_KEY_PROD || secrets.YANDEX_STORAGE_SECRET_KEY_DEV }}
          TELEGRAM_ALERT_BOT_TOKEN_VAL: ${{ secrets.TELEGRAM_ALERT_BOT_TOKEN }}
          TELEGRAM_ALERT_CHAT_ID_VAL: ${{ secrets.TELEGRAM_ALERT_CHAT_ID }}
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin

          # Step 1: Check FUNCTION_ARCHIVE_URL
          if [ -z "$FUNCTION_ARCHIVE_URL" ]; then
            echo "‚ùå Error: FUNCTION_ARCHIVE_URL is not set"
            exit 1
          fi

          echo "üì¶ Archive URL: $FUNCTION_ARCHIVE_URL"

          # Step 2: Extract bucket and object key from URL
          # URL format: https://storage.yandexcloud.net/<bucket>/<object-key>
          OBJECT_KEY="${FUNCTION_ARCHIVE_URL#https://storage.yandexcloud.net/${YANDEX_STORAGE_BUCKET}/}"

          if [ -z "$OBJECT_KEY" ] || [ "$OBJECT_KEY" = "$FUNCTION_ARCHIVE_URL" ]; then
            echo "‚ùå Error: Failed to extract object key from URL: $FUNCTION_ARCHIVE_URL"
            exit 1
          fi

          echo "üì¶ Bucket: ${YANDEX_STORAGE_BUCKET}"
          echo "üì¶ Object key: ${OBJECT_KEY}"

          # Step 3: Download archive from Object Storage
          echo "üì• Downloading archive from Object Storage..."
          yc storage s3 cp \
            s3://${YANDEX_STORAGE_BUCKET}/${OBJECT_KEY} \
            ./function.zip

          # Check if download was successful
          if [ $? -ne 0 ]; then
            echo "‚ùå Error: Failed to download archive from Object Storage"
            exit 1
          fi

          # Step 4: Verify file exists and is not empty
          if [ ! -f ./function.zip ]; then
            echo "‚ùå Error: Archive file ./function.zip not found after download"
            exit 1
          fi

          # Check file size (must be > 0)
          FILE_SIZE=$(stat -f%z ./function.zip 2>/dev/null || stat -c%s ./function.zip 2>/dev/null || echo "0")
          if [ "$FILE_SIZE" -eq 0 ]; then
            echo "‚ùå Error: Archive file ./function.zip is empty (size: $FILE_SIZE bytes)"
            exit 1
          fi

          echo "‚úÖ Archive downloaded successfully"
          echo "üìä Archive size: $(ls -lh ./function.zip | awk '{print $5}')"
          ls -lh ./function.zip

          # Step 5: Prepare function deployment
          FUNCTION_NAME=${{ github.ref == 'refs/heads/main' && 'dating-app-backend-prod' || 'dating-app-backend-staging' }}
          FUNCTION_ID=${{ github.ref == 'refs/heads/main' && 'd4enks8erf8eentnojj9' || 'd4enks8erf8eentnojj9' }}

          # Use existing function ID or create new function
          if [ -z "$FUNCTION_ID" ] || [ "$FUNCTION_ID" = "d4enks8erf8eentnojj9" ]; then
            # Use existing function
            FUNCTION_ID="d4enks8erf8eentnojj9"
            echo "Using existing function: $FUNCTION_ID"
          else
            # Create function if it doesn't exist
            FOLDER_ID="${{ secrets.YC_FOLDER_ID || 'b1g6rst3sps7hhu8tqla' }}"
            yc serverless function create \
              --name $FUNCTION_NAME \
              --description "Dating app backend API" \
              --folder-id $FOLDER_ID || echo "Function already exists"
            
            if [ $? -ne 0 ]; then
              echo "‚ö†Ô∏è  Warning: Function creation check failed, continuing..."
            fi
            
            FUNCTION_ID=$(yc serverless function get --name $FUNCTION_NAME --format json | jq -r '.id')
            if [ -z "$FUNCTION_ID" ] || [ "$FUNCTION_ID" = "null" ]; then
              echo "‚ùå Error: Failed to get function ID"
              exit 1
            fi
          fi

          # Build environment variables string
          ENV_STRING="NODE_ENV=${{ github.ref == 'refs/heads/main' && 'production' || 'development' }},PORT=8080"

          # Helper function to safely add environment variable to ENV_STRING
          add_env_var() {
            local key=$1
            local value=$2
            if [ -n "$value" ] && [ "$value" != "null" ]; then
              ENV_STRING="${ENV_STRING},${key}=${value}"
            fi
          }

          # Add variables from env section
          add_env_var "YDB_ENDPOINT" "$YDB_ENDPOINT_VAL"
          add_env_var "YDB_DATABASE" "$YDB_DATABASE_VAL"
          add_env_var "YDB_TOKEN" "$YDB_TOKEN_VAL"

          # For JSON values (YC_SERVICE_ACCOUNT_KEY), use base64 encoding
          if [ -n "$YC_SA_KEY_VAL" ] && [ "$YC_SA_KEY_VAL" != "null" ]; then
            YC_SA_KEY_B64=$(printf '%s' "$YC_SA_KEY_VAL" | base64 -w 0 | tr -d '\n')
            ENV_STRING="${ENV_STRING},YC_SERVICE_ACCOUNT_KEY_B64=${YC_SA_KEY_B64}"
            ENV_STRING="${ENV_STRING},YC_SERVICE_ACCOUNT_KEY=${YC_SA_KEY_VAL}"
          fi

          add_env_var "TELEGRAM_BOT_TOKEN" "$TELEGRAM_BOT_TOKEN_VAL"
          add_env_var "YANDEX_STORAGE_BUCKET" "$YANDEX_STORAGE_BUCKET_VAL"
          add_env_var "YANDEX_STORAGE_ACCESS_KEY" "$YANDEX_STORAGE_ACCESS_KEY_VAL"
          add_env_var "YANDEX_STORAGE_SECRET_KEY" "$YANDEX_STORAGE_SECRET_KEY_VAL"

          ENV_STRING="${ENV_STRING},TELEGRAM_ALERT_ENABLED=true"

          add_env_var "TELEGRAM_ALERT_BOT_TOKEN" "$TELEGRAM_ALERT_BOT_TOKEN_VAL"
          add_env_var "TELEGRAM_ALERT_CHAT_ID" "$TELEGRAM_ALERT_CHAT_ID_VAL"

          ENV_STRING="${ENV_STRING},ALLOWED_ORIGINS=https://dating-app-storage.website.yandexcloud.net,https://lug-admin-deploy.website.yandexcloud.net"

          # Step 6: Create function version with local archive
          echo "üöÄ Creating function version..."
          echo "üì¶ Using local archive: ./function.zip"

          yc serverless function version create \
            --function-id "$FUNCTION_ID" \
            --runtime nodejs18 \
            --entrypoint handler.handler \
            --memory 128m \
            --execution-timeout 30s \
            --source-path ./function.zip \
            --service-account-id aje0defcl8b2577p01hg \
            --environment "$ENV_STRING"

          # Check if deployment was successful
          if [ $? -ne 0 ]; then
            echo "‚ùå Error: Failed to create function version"
            exit 1
          fi

          echo "‚úÖ Function version created successfully"

          # Step 7: Clean up local archive after deployment
          rm -f ./function.zip
          if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è  Warning: Failed to remove local archive (non-critical)"
          else
            echo "üßπ Cleaned up local archive"
          fi

          echo "FUNCTION_ID=$FUNCTION_ID" >> $GITHUB_ENV

      - name: Get function URL
        id: get-url
        env:
          YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
        run: |
          export PATH=$PATH:$HOME/yandex-cloud/bin
          FUNCTION_ID=${FUNCTION_ID:-d4enks8erf8eentnojj9}
          FUNCTION_URL="https://functions.yandexcloud.net/$FUNCTION_ID"
          echo "url=$FUNCTION_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Backend deployed successfully!"
          echo "üåê Backend URL: $FUNCTION_URL"
          echo "üåê API Gateway: https://d5dc4655gjtafu92k0od.yl4tuxdu.apigw.yandexcloud.net"

      - name: Deployment summary
        run: |
          echo "‚úÖ Backend deployment completed!"
          echo "üåê Backend URL: ${{ steps.get-url.outputs.url }}"
          echo "üìù Update frontend and admin config.js with this URL"
